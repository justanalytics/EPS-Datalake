version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select \nsri_del_departments.NAME\n,sri_del_departments.CODE\n,sri_del_departments.FORM_TYPE\n,sri_del_departments.DEPT_REFERENCE\n,sri_del_departments.OFFICE_CODE\n,case  \n    when sri_del_departments.CODE in ('100', 'AUT', 'ELR', 'ENC', 'LRS', 'LT', 'RAE', 'RAX', 'RBR', 'RDK', 'RME', 'RRA', 'TCF', 'TEC', 'UWI') then 'REPAIRS' \n    when sri_del_departments.CODE in ('BSD', 'DD', 'DDC', 'DDP', 'DDR', 'DDS', 'DDT', 'DP', 'DRY', 'DSP', 'FDD') then 'DRY DOCK' \n    when sri_del_departments.FORM_TYPE = 'P' and not sri_del_departments.CODE in ('100', 'AUT', 'BSD', 'DD', 'DDC', 'DDP', 'DDR', 'DDS', 'DDT', 'DP', 'DRY', 'DSP', 'ELR', 'ENC', 'FDD', 'LRS', 'LT', 'RAE', 'RAX', 'RBR', 'RDK', 'RME', 'RRA', 'TCF', 'TEC', 'UWI') then 'STORES' \n    when sri_del_departments.FORM_TYPE = 'S' and not sri_del_departments.CODE in ('100', 'AUT', 'BSD', 'DD', 'DDC', 'DDP', 'DDR', 'DDS', 'DDT', 'DP', 'DRY', 'DSP', 'ELR', 'ENC', 'FDD', 'LRS', 'LT', 'RAE', 'RAX', 'RBR', 'RDK', 'RME', 'RRA', 'TCF', 'TEC', 'UWI') then 'SPARES' \n    else 'OTHERS' \nend as department_type\n,sha2(coalesce(sri_del_departments.CODE,''),512) as department_id\n,integration_key\n,null as w_x_custom\n,w_job_instance_id\n,w_refresh_ts\n,null as w_curr_rec_flg\n,w_source_system as w_data_src_id\n,w_location\n,w_batch_id\n,'${business_date}' as business_date \nfrom ${p_epsdl_sri_db}.sri_del_departments sri_del_departments\nwhere sri_del_departments.w_business_dt='${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'TANKPAC'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_department"
  merge_columns:
  - "name"
  - "code"
  - "form_type"
  - "dept_reference"
  - "office_code"
  - "department_type"
  - "department_id"
  endpoint: "lo_delta_tables"

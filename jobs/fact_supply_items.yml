version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with\nMV_SUPPLY_ITEMS_OPEX_MONITOR as \n(\nselect distinct a.DEPARTMENT, B.ITEM_SYSTEM_CODE, B.ITEM_SUBSYSTEM_CODE,\ncoalesce(C.LEDGER_CARD, D.LEDGER_CARD, E.LEDGER_CARD,F.LEDGER_CARD,G.LEDGER_CARD,H.LEDGER_CARD) LEDGER_CARD,a.ORDER_CODE,a.ORDER_SUPPLIER,a.ORDER_DATE,a.DOCUMENT_DATE,a.DOCUMENT_CODE,\na.LINE_TYPE,a.DISPUTED_DATE,a.DISPUTED_COMMENTS,a.APPROVER,B.PARCIAL,B.INVOICE_QTY,B.ORDER_QTY,B.ORDER_DISCOUNT,B.ORDER_RATE,B.ORDER_PRICE,B.REQUESTED_QTY,B.APPROVED_QTY, \nB.ORDER_CURRENCY,B.ITEM_SERIAL_NO,B.ITEM_REF_CODE,a.vessel_code,b.invoice_price,b.INVOICE_RATE,b.INVOICE_DISCOUNT,a.comments\nFROM ${p_epsdl_db}.dim_REQUISITIONS A\ninner join ${p_epsdl_db}.dim_SUPPLY_ITEMS B on a.ORDER_CODE = B.ORDER_CODE and a.ORDER_SUPPLIER = B.ORDER_SUPPLIER AND EXTRACT( YEAR FROM a.DOCUMENT_DATE)  =  extract(year from date_add(current_date, - 28))\nleft outer join ${p_epsdl_sri_db}.sri_item_ledgers C on C.DEPARTMENT = a.DEPARTMENT and C.CATALOGUE = B.ITEM_SYSTEM_CODE and C.CATALOGUE_GROUP = B.ITEM_SUBSYSTEM_CODE and C.w_business_dt='${business_date[0..9]}'\nleft outer join ${p_epsdl_sri_db}.sri_item_ledgers D on D.DEPARTMENT = a.DEPARTMENT and D.CATALOGUE = B.ITEM_SYSTEM_CODE and D.CATALOGUE_GROUP = 'ALL' and D.w_business_dt='${business_date[0..9]}'\nleft outer join ${p_epsdl_sri_db}.sri_item_ledgers E on E.DEPARTMENT = a.DEPARTMENT and E.CATALOGUE = 'ALL' and E.CATALOGUE_GROUP ='ALL' and E.w_business_dt='${business_date[0..9]}'\nleft outer join ${p_epsdl_sri_db}.sri_item_ledgers F on F.DEPARTMENT = a.DEPARTMENT and F.CATALOGUE = 'ALL' and F.w_business_dt='${business_date[0..9]}'\nLEFT OUTER JOIN ${p_epsdl_sri_db}.sri_item_ledgers G ON G.DEPARTMENT = A.DEPARTMENT AND G.CATALOGUE = '*' AND G.CATALOGUE_GROUP = 'ALL' and G.w_business_dt='${business_date[0..9]}'\nleft outer join ${p_epsdl_sri_db}.sri_item_ledgers H on H.DEPARTMENT = a.DEPARTMENT and H.CATALOGUE = '*' and H.CATALOGUE_GROUP = '*' and H.w_business_dt='${business_date[0..9]}'\n)\nselect\nMV_SUPPLY_ITEMS_OPEX_MONITOR.approver,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.department,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.disputed_comments,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.disputed_date,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.document_code,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.document_date,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.item_ref_code,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.item_serial_no,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.item_subsystem_code,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.item_system_code,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.line_type,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_code,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_currency,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_date,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_supplier,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.parcial,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.vessel_code,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.approved_qty,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.requested_qty,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_discount,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_rate,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_price,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.order_qty,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.invoice_discount,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.invoice_rate,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.invoice_price,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.invoice_qty,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.comments,\ncase when upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%DRY DOCK%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%DRY%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '% DD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '% DD/%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%[DD]%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like 'DD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%TAKE OVER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%UWILD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%UWLD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%TAKEOVER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%CAPITAL%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%VOY%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%VOYAGE%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%VOYAGE COST%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%CAPEX%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%SCRUBBER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%BWTS%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%TAKEOVER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%NEW%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.comments) like '%PROJECT%' or MV_SUPPLY_ITEMS_OPEX_MONITOR.DEPARTMENT in ( 'DD', 'DDC', 'DDP', 'DDR', 'DDS', 'DDT', 'DP', 'DRY', 'DSP', 'FDD' ) then 'Y' else 'N' end as dd_po_flag, \ncase  when MV_SUPPLY_ITEMS_OPEX_MONITOR.APPROVER is null then 'N' else 'Y' end  as approver_po_flag,\nx.delivery_date,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.LEDGER_CARD,\nnull as integration_key,\nnull as w_x_custom,\nnull as w_job_instance_id,\nnull as w_refresh_ts,\nnull as w_curr_rec_flg,\nnull as w_data_src_id,\nnull as w_location,\nnull as w_batch_id,\n'${business_date[0..9]}' as business_date\nfrom\nMV_SUPPLY_ITEMS_OPEX_MONITOR left join ${p_epsdl_db}.dim_order_details x  on MV_SUPPLY_ITEMS_OPEX_MONITOR.order_code = x.order_code"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'TANKPAC'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_supply_items"
  merge_columns:
  - "approver"
  - "department"
  - "disputed_comments"
  - "disputed_date"
  - "document_code"
  - "document_date"
  - "item_ref_code"
  - "item_serial_no"
  - "item_subsystem_code"
  - "item_system_code"
  - "line_type"
  - "order_code"
  - "order_currency"
  - "order_date"
  - "order_supplier"
  - "parcial"
  - "vessel_code"
  - "approved_qty"
  - "requested_qty"
  - "order_discount"
  - "order_rate"
  - "order_price"
  - "order_qty"
  - "invoice_discount"
  - "invoice_rate"
  - "invoice_price"
  - "invoice_qty"
  - "comments"
  - "dd_po_flag"
  - "approver_po_flag"
  - "delivery_date"
  endpoint: "lo_delta_tables"

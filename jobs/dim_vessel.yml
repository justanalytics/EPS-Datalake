version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with\nvessel_list as (\n    select distinct VESSEL_CODE,short_name,company_group,v.w_business_dt,v.integration_key \n    from (\n        select  company as vessel_code,w_business_dt,integration_key \n        from  ${p_epsdl_sri_db}.sri_companies\n        ) v\n    left join (\n        select ci.*,row_number() over (partition by company order  by system) rnum \n        from\n            (select  company,short_name,company_group,'EPS' system from  ${p_epsdl_sri_db}.sri_companies) ci ) c\n    on v.vessel_code = c.company and  c.rnum = 1\n),\noth_vessel as (\n    select\n    'Jan 2014' PERIOD,\n    vessel_code VESSEL_CODE,\n    short_name VESSEL_NAME,\n    company_group COMPANY_STRUCTURE_IN_DANAOS,\n    (case when company_group in ('C', 'P', 'U', 'W') then 'QPS'  end)  QPS_OWNERSHIP,\n    case when company_group in ('C') then 'QPS'  end  QCT_OWNERSHIP,\n    case when company_group in ('U') then 'EPS UK' when  company_group in ('C', 'P', 'W','T') then 'QPS SG' end   MANAGED_BY_EPS,\n    null OWNERSHIP_TYPE,\n    null BUILT,\n    null DATE_BUILT,\n    null USEFUL_LIFE,\n    null LWT,\n    null DWT,\n    null FLEET_TYPE_SUB,\n    null FLEET_TYPE,\n    to_date('01-jan-2001','dd-MMM-yyyy') START_DATE,\n    to_date('01-dec-2004','dd-MMM-yyyy') sold_date,\n    to_date('01-jan-2001','dd-MMM-yyyy') JOURNAL_START_DATE,\n    date_add(CAST(current_timestamp() as DATE), 365) JOURNAL_END_DATE,\n    null QCT_START_DATE,\n    null ADDL_ATTRIBUTE1,\n    null ADDL_ATTRIBUTE2,\n    null ADDL_ATTRIBUTE3,\n    null LAST_UPDATED_DATE,\n    null LAST_UPDATED_BY,\n    null W_SOURCE_SYSTEM,\n    w_business_dt,\n    null W_DATA_SOURCE_ID,\n    null w_refresh_ts,\n    null W_BATCH_ID,\n    null w_src_file_name,\n    null w_location,\n    null fleet,\n    null region,\n    null vessel_ownership,\n    null as w_job_instance_id,\n    p.integration_key\n  from vessel_list p\n  where \n  not exists(select 1 from ${p_epsdl_sri_db}.sri_vesselmaster where p.vessel_code=vessel_code)\n  )\n  \nselect \n    v.period,\n    v.vessel_code,\n    v.vessel_name,\n    v.company_structure_in_danaos,\n    v.qps_ownership,\n    v.qct_ownership,\n    v.managed_by_eps,\n    v.ownership_type,\n    v.built,\n    v.date_built,\n    v.useful_life,\n    v.lwt,\n    v.dwt,\n    v.fleet_type_sub,\n    v.fleet_type,\n    v.start_date,\n    v.sold_date,\n    v.journal_start_date,\n    v.journal_end_date,\n    v.qct_start_date,\n    v.addl_attribute1,\n    v.addl_attribute2,\n    v.addl_attribute3,\n    v.last_updated_date,\n    v.last_updated_by,\n    v.w_source_system as w_data_src_id,\n    v.w_business_dt as business_date,\n    v.w_refresh_ts,\n    v.w_batch_id,\n    v.vessel_ownership,\n    v.region,\n    v.integration_key,\n    v.w_job_instance_id,\n    v.w_location,\n\tv.fleet,\n    null as w_x_custom,\n    null as w_curr_rec_flg,\n\tcase when v.managed_by_eps in ('EPS SG','EPS UK') then 'EPS' end eps_ownership,\n\tcase when v.managed_by_eps in ('EPS UK') then 'EPS UK' end eps_uk_ownership\nfrom \n    (\n    select  \n    period\t\t\n    ,vessel_code\t\t\n    ,vessel_name\t\t\n    ,company_structure_in_danaos\t\t\n    ,qps_ownership\t\t\n    ,qct_ownership\n    ,managed_by_eps\t\t\t\t\n    ,ownership_type\t\t\n    ,built\t\t\n    ,date_built\t\t\n    ,useful_life\t\t\n    ,lwt\t\t\n    ,dwt\t\t\n    ,fleet_type_sub\t\t\n    ,fleet_type\t\t\n    ,start_date\t\t\n    ,sold_date\t\t\n    ,journal_start_date\t\t\n    ,journal_end_date\t\t\n    ,qct_start_date\t\t\n    ,addl_attribute1\t\t\n    ,addl_attribute2\t\t\n    ,addl_attribute3\t\t\n    ,last_updated_date\t\t\n    ,last_updated_by\t\t\t\t\n    ,region\t\t\n    ,integration_key\n    ,w_source_system\n    ,w_src_file_name\n    ,w_refresh_ts\n    ,w_business_dt\n    ,w_location\n    ,w_batch_id\n    ,fleet\n    ,vessel_ownership\n    ,region\n    ,w_job_instance_id\n  from ${p_epsdl_sri_db}.sri_vesselmaster union all \n  select \n    period\t\t\n    ,vessel_code\t\t\n    ,vessel_name\t\t\n    ,company_structure_in_danaos\t\t\n    ,qps_ownership\t\t\n    ,qct_ownership\n    ,managed_by_eps\t\t\t\t\n    ,ownership_type\t\t\n    ,built\t\t\n    ,date_built\t\t\n    ,useful_life\t\t\n    ,lwt\t\t\n    ,dwt\t\t\n    ,fleet_type_sub\t\t\n    ,fleet_type\t\t\n    ,start_date\t\t\n    ,sold_date\t\t\n    ,journal_start_date\t\t\n    ,journal_end_date\t\t\n    ,qct_start_date\t\t\n    ,addl_attribute1\t\t\n    ,addl_attribute2\t\t\n    ,addl_attribute3\t\t\n    ,last_updated_date\t\t\n    ,last_updated_by\t\t\t\t\n    ,region\n    ,integration_key\t\t\n    ,w_source_system\n    ,w_src_file_name\n    ,w_refresh_ts\n    ,w_job_instance_id\n    ,w_business_dt\n    ,w_location\n    ,w_batch_id\n    ,fleet\n    ,vessel_ownership\n    ,region\n  from oth_vessel) v \nwhere v.w_business_dt='${business_date[0..9]}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_vessel"
  merge_columns:
  - "period"
  - "vessel_code"
  - "vessel_name"
  - "company_structure_in_danaos"
  - "qps_ownership"
  - "qct_ownership"
  - "managed_by_eps"
  - "ownership_type"
  - "built"
  - "date_built"
  - "useful_life"
  - "lwt"
  - "dwt"
  - "fleet_type_sub"
  - "fleet_type"
  - "start_date"
  - "sold_date"
  - "journal_start_date"
  - "journal_end_date"
  - "qct_start_date"
  - "addl_attribute1"
  - "addl_attribute2"
  - "addl_attribute3"
  - "last_updated_date"
  - "last_updated_by"
  - "vessel_ownership"
  - "region"
  endpoint: "lo_delta_tables"

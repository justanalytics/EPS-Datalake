version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with \nMV_SUPPLY_ITEMS_OPEX_MONITOR as\n(\nselect distinct a.DEPARTMENT, B.ITEM_SYSTEM_CODE, B.ITEM_SUBSYSTEM_CODE,\ncoalesce(C.LEDGER_CARD, D.LEDGER_CARD, E.LEDGER_CARD,F.LEDGER_CARD,G.LEDGER_CARD,H.LEDGER_CARD) LEDGER_CARD,a.ORDER_CODE,a.ORDER_SUPPLIER,a.ORDER_DATE,a.DOCUMENT_DATE,a.DOCUMENT_CODE,\na.LINE_TYPE,a.DISPUTED_DATE,a.DISPUTED_COMMENTS,a.APPROVER,B.PARCIAL,B.INVOICE_QTY,B.ORDER_QTY,B.ORDER_DISCOUNT,B.ORDER_RATE,B.ORDER_PRICE,B.REQUESTED_QTY,B.APPROVED_QTY, \nB.ORDER_CURRENCY,B.ITEM_SERIAL_NO,B.ITEM_REF_CODE,a.vessel_code,b.invoice_price,b.INVOICE_RATE,b.INVOICE_DISCOUNT,a.comments\nFROM ${p_epsdl_sri_db}.sri_requisitions A\ninner join ${p_epsdl_sri_db}.sri_supply_items B \non \na.ORDER_CODE = B.ORDER_CODE and a.ORDER_SUPPLIER = B.ORDER_SUPPLIER AND YEAR(a.DOCUMENT_DATE)=year(date_add(current_date(),-28)) and b.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers C on C.DEPARTMENT = a.DEPARTMENT and C.CATALOGUE = B.ITEM_SYSTEM_CODE and C.CATALOGUE_GROUP = B.ITEM_SUBSYSTEM_CODE and c.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers D on D.DEPARTMENT = a.DEPARTMENT and D.CATALOGUE = B.ITEM_SYSTEM_CODE and D.CATALOGUE_GROUP = 'ALL' and d.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers E on E.DEPARTMENT = a.DEPARTMENT and E.CATALOGUE = 'ALL' and E.CATALOGUE_GROUP ='ALL' and e.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers F on F.DEPARTMENT = a.DEPARTMENT and F.CATALOGUE = 'ALL' and f.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers G on G.DEPARTMENT = A.DEPARTMENT AND G.CATALOGUE = '*' AND G.CATALOGUE_GROUP = 'ALL' and g.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers H on H.DEPARTMENT = a.DEPARTMENT and H.CATALOGUE = '*' and H.CATALOGUE_GROUP = '*' and h.w_business_dt = '${business_date}'\nwhere a.w_business_dt = '${business_date}'\n)\n\nselect\nMV_SUPPLY_ITEMS_OPEX_MONITOR.INVOICE_PRICE,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.LINE_TYPE,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.PARCIAL,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_PRICE,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_QTY,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_RATE,\nMV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_DISCOUNT,\nVESSEL_OPEX_MONITOR.vessel_id,\nCOA_OPEX_MONITOR.account_id,\ncase  when (MV_SUPPLY_ITEMS_OPEX_MONITOR.INVOICE_PRICE in (0) or MV_SUPPLY_ITEMS_OPEX_MONITOR.INVOICE_PRICE is null) and MV_SUPPLY_ITEMS_OPEX_MONITOR.LINE_TYPE in ('O', 'SO') then case  when MV_SUPPLY_ITEMS_OPEX_MONITOR.PARCIAL = 1 then MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_PRICE * MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_QTY * MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_RATE - MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_PRICE * MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_QTY * MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_DISCOUNT / 100 * MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_RATE end  end as item_amount_po_usd,\nORDER_DETAILS.DELIVERY_DATE, \nCOA_OPEX_MONITOR.LEDGER_CARD, \nVESSEL_OPEX_MONITOR.FLEET, \nVESSEL_OPEX_MONITOR.VESSEL_NAME, \nMV_SUPPLY_ITEMS_OPEX_MONITOR.DOCUMENT_CODE, \nMV_SUPPLY_ITEMS_OPEX_MONITOR.DOCUMENT_DATE, \nMV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_CODE, \nMV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS\nfrom\nMV_SUPPLY_ITEMS_OPEX_MONITOR MV_SUPPLY_ITEMS_OPEX_MONITOR\nleft join\n${p_epsdl_db}.dim_gl_vessel VESSEL_OPEX_MONITOR\non\nVESSEL_OPEX_MONITOR.VESSEL_CODE = MV_SUPPLY_ITEMS_OPEX_MONITOR.VESSEL_CODE \nand \nVESSEL_OPEX_MONITOR.START_DATE <= date_format('2019-12-31 12:00:00' , 'yyyy-MM-dd HH:mm:ss')  \nand (VESSEL_OPEX_MONITOR.SOLD_DATE >= date_format('2019-01-01 12:00:00' , 'yyyy-MM-dd HH:mm:ss') or VESSEL_OPEX_MONITOR.SOLD_DATE is null) \nleft join\n${p_epsdl_db}.dim_gl_account COA_OPEX_MONITOR\non\nCOA_OPEX_MONITOR.LEDGER_CARD = MV_SUPPLY_ITEMS_OPEX_MONITOR.LEDGER_CARD\nleft join \n${p_epsdl_sri_db}.sri_order_details ORDER_DETAILS  \non \nORDER_DETAILS.ORDER_CODE = MV_SUPPLY_ITEMS_OPEX_MONITOR.ORDER_CODE\nand ORDER_DETAILS.DELIVERY_DATE is null \nand ORDER_DETAILS.w_business_dt = '${business_date}'\nwhere\n(case  when upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%DRY DOCK%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%DRY%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '% DD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '% DD/%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%[DD]%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like 'DD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%TAKE OVER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%UWILD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%UWLD%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%TAKEOVER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%CAPITAL%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%VOY%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%VOYAGE%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%VOYAGE COST%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%CAPEX%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%SCRUBBER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%BWTS%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%TAKEOVER%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%NEW%' or upper(MV_SUPPLY_ITEMS_OPEX_MONITOR.COMMENTS) like '%PROJECT%' or MV_SUPPLY_ITEMS_OPEX_MONITOR.DEPARTMENT in ('DD', 'DDC', 'DDP', 'DDR', 'DDS', 'DDT', 'DP', 'DRY', 'DSP', 'FDD') then 'Y' else 'N' end )  = 'N' \nand \ncase  when MV_SUPPLY_ITEMS_OPEX_MONITOR.APPROVER is null then 'N' else 'Y' end  = 'Y' \n"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_os_po_current_year"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select \n        question_number\n        ,chapter\n        ,substr(question_number,1,(instr(question_number,'.')-1)) as chapter_no\n        ,section_header\n        ,section_sub_header\n        ,question_text\n        ,'MOC' as flag\n        ,integration_key\n        ,null as w_x_custom\n        ,w_job_instance_id\n        ,w_refresh_ts\n        ,null as w_curr_rec_flg\n        ,w_source_system as w_data_src_id\n        ,w_location\n        ,w_batch_id\n        ,'${business_date}' as business_date \nfrom ${p_epsdl_sri_db}.sri_moc_viq_questions\nwhere w_business_dt='${business_date}'\n\nunion all\n\nselect \n        q_no\n        ,q_category as chapter\n        ,cast (round(q_cat_Sort_no) as int) as chapter_no\n        ,null as section_header\n        ,null as section_sub_header\n        ,q_text as question_text\n        ,q_type as flag\n        ,integration_key\n        ,null as w_x_custom\n        ,w_job_instance_id\n        ,w_refresh_ts\n        ,null as w_curr_rec_flg\n        ,w_source_system as w_data_src_id\n        ,w_location\n        ,w_batch_id\n        ,'${business_date}' as business_date\nfrom ${p_epsdl_sri_db}.sri_nav_audit_qn_master\nwhere w_business_dt='${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'VLOG'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_sire_inspection"
  merge_columns:
  - "question_number"
  - "chapter"
  - "section_header"
  - "section_sub_header"
  - "question_text"
  - "flag"
  - "chapter_no"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select * from\n(\nselect\nnull as agreed_speed,\nnull as Agreed_Speed_A,\nnull as Agreed_Speed_D,\nnull as Agreed_Speed_O,\nnull as agreed_speed_cons,\nnull as agreed_speed_cons_A,\nnull as agreed_speed_cons_D,\nnull as agreed_speed_cons_O,\nnull as agreed_speed_engine_load,\nnull as agreed_speed_engine_load_A,\nnull as agreed_speed_engine_load_D,\nnull as agreed_speed_engine_load_O,\nnull as Anchorage_Delay,\nsri_BP_PORTS.area,\nnull as Arr_Dep_Status,\ncoalesce(sri_expected_call.vessel_eta_local,sri_expected_call.eta_local) as Arrival_Local,\nnull as Ballast_Laden_From_Port,\nnull as ballast_laden_to_port,\ncase when sri_telegrams_A.telegram_type='A' then sri_telegrams_A.next_port end  as Ballast_Laden_to_Port_A,\ncase when sri_telegrams_D.telegram_type='D' then sri_telegrams_D.next_port end as Ballast_Laden_to_Port_D,\ncase when sri_telegrams_O.telegram_type='O' then sri_telegrams_O.next_port end as Ballast_Laden_to_Port_O,\nnull as Berth_to_Pilot,\nnull as Cargo_Inspector,\nnull as Cargo_Scheduler,\nsri_BP_PORTS.port_country as country,\nnull as Dem_Des_Days,\nnull as Dem_Des_Rate,\ncoalesce(sri_expected_call.vessel_etd_local,sri_expected_call.etd_local) as Departure_Local,\nnull as Est_Cost_Base,\ncoalesce(sri_expected_call.vessel_eta,sri_expected_call.eta) as Eta_Gmt,\ncoalesce(sri_expected_call.etb_local,sri_expected_call.etb) as ETB,\ncoalesce(sri_expected_call.vessel_etd,sri_expected_call.etd) as Etd_Gmt,\nsri_expected_call.Extra_Port_Days as Extra_Port_Days,\nsri_expected_call.Extra_Sea_Days as Extra_Sea_Days,\nnull as Fixture_No,\nsri_expected_call.idle_port_days as idle_port_days,\nnull as Instructed_SAT_Local,\nnull as instructed_speed,\ncase when sri_telegrams_custom_A.telegram_type='A' then sri_telegrams_custom_A.instructed_speed end as Instructed_Speed_A,\ncase when sri_telegrams_custom_D.telegram_type='D' then sri_telegrams_custom_D.instructed_speed end as Instructed_Speed_D,\ncase when sri_telegrams_custom_O.telegram_type='O' then sri_telegrams_custom_O.instructed_speed end as Instructed_Speed_O,\nnull as Is_Current_Port_Call,\nnull as Last_Update_Gmt,\nnull as Last_User_ID,\nnull as Low_Speed_Days,\nnull as Low_Speed_Miles,\nnull as Low_Sulfur_ECA,\nnull as LS_Miles,\nnull as LS_Port_Days,\nnull as LS_Sea_Days,\nnull as Master_Seq,\nsri_expected_call.miles as miles,\nsri_expected_call.seq_no as Order,\nnull as Pilot_to_Berth,\nsri_expected_call.port_days as port_days,\nnull as Port_Exp_Amount_Base,\nnull as Port_Exp_Amount_Local,\nnull as Port_Exp_Curr,\nnull as Port_Exp_Exch_Rate,\nsri_expected_call.port_action as Port_Func,\nsri_expected_call.port_name as port_name,\nnull as Port_No,\nnull as Port_Range,\nnull as Port_Region,\nnull as Port_Status_Code,\nnull as Remarks_Fixture,\nsri_expected_call.remarks as Remarks_Operations,\nsri_expected_call.sea_days as sea_days,\nsri_expected_call.seq_no as Seq,\nnull as Speed_From_Port,\nnull as Speed_Instruction_Type,\nnull as Speed_to_Port,\nsri_BP_PORTS.unctad_code as UN_Code,\nsri_expected_call.vessel_code as vessel_code,\nsri_expected_call.via_canal as Via,\nsri_expected_call.voy_id as Voyage_No,\nnull as Weather_Factor_From_Port,\nnull as Weather_Factor_to_Port,\nsri_expected_call.port_action as name,\nsri_expected_call.exp_ref as exp_ref,\nsri_telegrams_A.telegram_date as telegram_date_A,\nsri_telegrams_D.telegram_date as telegram_date_D,\nsri_telegrams_O.telegram_date as telegram_date_O,\nsri_telegrams_A.telegram_type as telegram_type_A,\nsri_telegrams_D.telegram_type as telegram_type_D,\nsri_telegrams_O.telegram_type as telegram_type_O,\nvessel.vessel_id as vessel_id,\nsri_expected_call.integration_key,\nsri_expected_call.w_source_system as w_data_src_id,\nsri_expected_call.w_src_file_name,\nsri_expected_call.w_refresh_ts,\nsri_expected_call.w_job_instance_id,\nsri_expected_call.w_business_dt,\nsri_expected_call.w_location,\nsri_expected_call.w_batch_id,\nrow_number() over(partition by sri_expected_call.VESSEL_CODE,sri_expected_call.voy_id,sri_expected_call.EXP_REF order by sri_telegrams_D.telegram_date desc) as rownum\nfrom \n${p_epsdl_sri_db}.sri_expected_call sri_expected_call\nleft join\n(\nselect a.port_name,b.area,b.port_country,a.unctad_code from \n${p_epsdl_sri_db}.sri_BP_PORTS A\nJOIN\n(\nSELECT * FROM \n(\nSELECT A.*,ROW_NUMBER() OVER(PARTITION BY BP_CODE ORDER BY PORT_NAME ASC) AS ROW_NUM\nFROM ${p_epsdl_sri_db}.sri_PORTS_LIBRARY A\nwhere A.w_business_dt='${business_date}'\n)\nWHERE ROW_NUM=1\n)\nB\nON\nB.BP_CODE=A.UNCTAD_CODE\nwhere A.w_business_dt='${business_date}'\n) sri_BP_PORTS\non\nsri_BP_PORTS.port_name=sri_expected_call.port_name\nleft join\n${p_epsdl_sri_db}.sri_telegrams sri_telegrams_A\non\nsri_telegrams_A.exp_ref=sri_expected_call.exp_ref\nand \nsri_telegrams_A.VESSEL_CODE=sri_expected_call.VESSEL_CODE\nand \nsri_telegrams_A.PORT_NAME=sri_expected_call.PORT_NAME\nand sri_telegrams_A.telegram_type='A'\nand sri_telegrams_A.w_business_dt='${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_telegrams_custom sri_telegrams_custom_A\non\nsri_telegrams_custom_A.VESSEL_CODE=sri_telegrams_A.VESSEL_CODE\nand \nsri_telegrams_custom_A.TELEGRAM_DATE=sri_telegrams_A.TELEGRAM_DATE\nand \nsri_telegrams_custom_A.TELEGRAM_TYPE=sri_telegrams_A.TELEGRAM_TYPE\nand\nsri_telegrams_custom_A.w_business_dt='${business_date}'\nleft join\n${p_epsdl_sri_db}.sri_telegrams sri_telegrams_D\non\nsri_telegrams_D.exp_ref=sri_expected_call.exp_ref\nand \nsri_telegrams_D.VESSEL_CODE=sri_expected_call.VESSEL_CODE\nand \nsri_telegrams_D.PORT_NAME=sri_expected_call.PORT_NAME\nand sri_telegrams_D.telegram_type='D'\nand sri_telegrams_D.w_business_dt='${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_telegrams_custom sri_telegrams_custom_D\non\nsri_telegrams_custom_D.VESSEL_CODE=sri_telegrams_D.VESSEL_CODE\nand \nsri_telegrams_custom_D.TELEGRAM_DATE=sri_telegrams_D.TELEGRAM_DATE\nand \nsri_telegrams_custom_D.TELEGRAM_TYPE=sri_telegrams_D.TELEGRAM_TYPE\nand sri_telegrams_custom_D.w_business_dt='${business_date}'\nleft join\n${p_epsdl_sri_db}.sri_telegrams sri_telegrams_O\non\nsri_telegrams_O.exp_ref=sri_expected_call.exp_ref\nand \nsri_telegrams_O.VESSEL_CODE=sri_expected_call.VESSEL_CODE\nand \nsri_telegrams_O.PORT_NAME=sri_expected_call.PORT_NAME\nand sri_telegrams_O.telegram_type='O'\nand sri_telegrams_O.w_business_dt='${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_telegrams_custom sri_telegrams_custom_O\non\nsri_telegrams_custom_O.VESSEL_CODE=sri_telegrams_O.VESSEL_CODE\nand \nsri_telegrams_custom_O.TELEGRAM_DATE=sri_telegrams_O.TELEGRAM_DATE\nand \nsri_telegrams_custom_O.TELEGRAM_TYPE=sri_telegrams_O.TELEGRAM_TYPE\nand sri_telegrams_custom_O.w_business_dt='${business_date}'\nleft join\n${p_epsdl_db}.dim_gl_vessel vessel\non\nvessel.vessel_code=sri_expected_call.vessel_code\nwhere sri_expected_call.w_business_dt='${business_date}'\n) where rownum=1"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
target:
  primary_key_columns:
  - "vessel_code"
  - "Voyage_No"
  - "exp_ref"
  - "w_data_src_id"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_port_calls_danaos"
  merge_columns:
  - "Agreed_Speed_A"
  - "Agreed_Speed_D"
  - "Agreed_Speed_O"
  - "agreed_speed_cons_A"
  - "agreed_speed_cons_D"
  - "agreed_speed_cons_O"
  - "agreed_speed_engine_load_A"
  - "agreed_speed_engine_load_D"
  - "agreed_speed_engine_load_O"
  - "Anchorage_Delay"
  - "area"
  - "Arr_Dep_Status"
  - "Arrival_Local"
  - "Ballast_Laden_From_Port"
  - "Ballast_Laden_to_Port_A"
  - "Ballast_Laden_to_Port_D"
  - "Ballast_Laden_to_Port_O"
  - "Berth_to_Pilot"
  - "Cargo_Inspector"
  - "Cargo_Scheduler"
  - "country"
  - "Dem_Des_Days"
  - "Dem_Des_Rate"
  - "Departure_Local"
  - "Est_Cost_Base"
  - "Eta_Gmt"
  - "ETB"
  - "Etd_Gmt"
  - "Extra_Port_Days"
  - "Extra_Sea_Days"
  - "Fixture_No"
  - "idle_port_days"
  - "Instructed_SAT_Local"
  - "Instructed_Speed_A"
  - "Instructed_Speed_D"
  - "Instructed_Speed_O"
  - "Is_Current_Port_Call"
  - "Last_Update_Gmt"
  - "Last_User_ID"
  - "Low_Speed_Days"
  - "Low_Speed_Miles"
  - "Low_Sulfur_ECA"
  - "LS_Miles"
  - "LS_Port_Days"
  - "LS_Sea_Days"
  - "Master_Seq"
  - "miles"
  - "Order"
  - "Pilot_to_Berth"
  - "port_days"
  - "Port_Exp_Amount_Base"
  - "Port_Exp_Amount_Local"
  - "Port_Exp_Curr"
  - "Port_Exp_Exch_Rate"
  - "Port_Func"
  - "port_name"
  - "Port_No"
  - "Port_Range"
  - "Port_Region"
  - "Port_Status_Code"
  - "Remarks_Fixture"
  - "Remarks_Operations"
  - "sea_days"
  - "Seq"
  - "Speed_From_Port"
  - "Speed_Instruction_Type"
  - "Speed_to_Port"
  - "UN_Code"
  - "vessel_code"
  - "Via"
  - "Voyage_No"
  - "Weather_Factor_From_Port"
  - "Weather_Factor_to_Port"
  - "port_action"
  - "exp_ref"
  - "telegram_date_A"
  - "telegram_date_D"
  - "telegram_date_O"
  - "telegram_type_A"
  - "telegram_type_D"
  - "telegram_type_O"
  - "w_data_src_id"
  endpoint: "lo_delta_tables"

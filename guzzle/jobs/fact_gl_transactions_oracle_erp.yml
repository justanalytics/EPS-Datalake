version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select \n      null as accrual_type\n      ,null as accrued_by_user\n      ,null as accrued_by_user_2\n      ,null as accrued_on_date\n      ,null as allocation_date_from\n      ,null as allocation_date_to\n      ,null as amount\n      ,null as application_code\n      ,null as application_ref\n      ,null as approval_level\n      ,null as approved_by\n      ,null as ar_type\n      ,null as bank\n      ,null as book_credit_off\n      ,null as book_debit_off\n      ,null as book_value\n      ,null as book_value_off\n      ,null as book_value2\n      ,null as book_value3\n      ,null as budget\n      ,null as bunker_price\n      ,null as bunker_qty\n      ,gl_traansactions.created_by as created_by_user\n      ,gl_traansactions.created_by as created_by_user_2\n      ,gl_traansactions.currency_code as currency\n      ,null as currency3\n      ,null as db_userid\n      ,case when gl_traansactions.entered_cr is null then 'D' else 'C' end as debit_credit\n      ,null as document_category\n      ,null as document_date\n      ,null as document_status\n      ,null as document_subject\n      ,null as document_subsubject\n      ,null as document_type\n      ,null as due_date\n      ,null as entry_number\n      ,null as entry_rate\n      ,null as entry_rate2\n      ,null as entry_rate3\n      ,null as filed_to\n      ,null as filed_to3\n      ,null as finalized_by_user\n      ,null as finalized_by_user_2\n      ,null as flag1\n      ,null as flag2\n      ,null as flag3\n      ,null as from_to\n      ,cast(coalesce(gl_traansactions.accounted_dr,gl_traansactions.accounted_cr) as decimal(38,18))/cast(nullif(coalesce(gl_traansactions.entered_dr,gl_traansactions.entered_cr),0) as decimal(38,18)) as fx_rate\n      ,null as import_status\n      ,null as imported_by\n      ,null as inc_exp_category\n      ,null as inc_exp_group\n      ,null as instrument_no\n      ,gl_traansactions.creation_date as issue_date\n      ,null as job_number\n      ,null as journal_company\n      ,period.end_date as journal_date\n      ,gl_traansactions.journal_line_num as journal_line\n      ,gl_traansactions.journal_header as journal_number\n      ,gl_traansactions.posted_date as journal_posting\n      ,gl_traansactions.journal_batch_name as journal_series\n      ,null as journal_status\n      ,null as journal_user\n      ,null as journal_user_2\n      ,gl_traansactions.last_update_date as last_updated\n      ,null as matching_company\n      ,null as matching_line\n      ,null as matching_number\n      ,null as matching_series\n      ,null as mc_reference\n      ,null as name\n      ,null as open_item_status\n      ,null as operation_code1\n      ,null as operation_code2\n      ,null as operation_id1\n      ,null as operation_id2\n      ,null as operation_subid_1\n      ,null as operation_subid_2\n      ,null as order_number\n      ,null as our_company\n      ,null as pay_approval_level\n      ,null as pay_flag\n      ,null as pay_selected\n      ,null as payment_method\n      ,null as place\n      ,null as prt_flag\n      ,null as remarks\n      ,null as reporting_amount\n      ,null as serial_no\n      ,null as set_currency_amount\n      ,null as spot_rate_flag\n      ,null as sup_match\n      ,null as supplier_code\n      ,null as team\n      ,gl_traansactions.accounted_cr as tot_book_credit\n      ,null as tot_book_credit2\n      ,null as tot_book_credit3\n      ,gl_traansactions.accounted_dr as tot_book_debit\n      ,null as tot_book_debit2\n      ,null as tot_book_debit3\n      ,gl_traansactions.entered_cr as tot_local_credit\n      ,gl_traansactions.entered_dr as tot_local_debit\n      ,null as transaction_type\n      ,null as vat_amount\n      ,null as vat_category\n      ,null as vat_number\n      ,null as vessel_code\n      ,null as withholding_tax_amount\n      ,null as withholding_tax_code\n      ,gl_traansactions.jounral_line_desc as journal_narrative\n      ,null as journal_reference\n      ,null as flag4\n      ,null as submission_date\n      ,null as value_date\n      ,null as transaction_cost\n      ,null as accrual_flag\n      ,null as order_code\n      ,null as document_code\n      ,null as internal_ref\n      ,null as row_num\n      ,coalesce(account.account_id,'000000') as account_id\n      ,coalesce(company.company_id,'0000') as company_id\n      ,coalesce(vessel.vessel_id,'0000') as vessel_id\n      ,coalesce(service.service_id,'00') as service_id\n      ,coalesce(department.department_id,'000') as department_id\n      ,coalesce(intercompany.intercompany_id,'0000') as intercompany_id\n       ,coalesce(future1.future1_id,'000') as future1_id\n       ,coalesce(future2.future2_id,'0000') as future2_id\n        ,coalesce(gl_trans_intermediate.company_code,'')||'~'||coalesce(gl_trans_intermediate.vessel_code,'')||'~'||coalesce(gl_trans_intermediate.service_code,'')||'~'||coalesce(gl_trans_intermediate.account_code,'')||'~'||coalesce(gl_trans_intermediate.intercompany_code,'')||'~'||coalesce(gl_trans_intermediate.department_code,'')||'~'||coalesce(gl_trans_intermediate.future1_code,'')||'~'||coalesce(gl_trans_intermediate.future2_code,'')as code_combination_id\n\n \n\n      ,gl_traansactions.journal_header || '~' || gl_traansactions.journal_line_num as journal_id\n      ,null as tot_global_credit\n      ,null as tot_global_debit\n      ,null as delete_flag\n      ,gl_traansactions.actual_flag\n      ,gl_traansactions.adjustment_period_flag\n      ,gl_traansactions.ledger_id\n      ,gl_traansactions.integration_key\n      ,null as w_x_custom\n      ,gl_traansactions.w_job_instance_id\n      ,gl_traansactions.w_refresh_ts\n      ,null as w_curr_rec_flg\n      ,'ORACLE' as w_data_src_id\n      ,gl_traansactions.w_location\n      ,gl_traansactions.w_batch_id\n\t  ,'${business_date}' as business_date\n\t  ,gl_traansactions.je_source\nfrom \n\n${p_epsdl_sri_db}.sri_oracle_gl_transaction gl_traansactions\nleft join ${p_epsdl_db}.fact_gl_transactions_intermediate_oracle_erp gl_trans_intermediate\non gl_traansactions.journal_header=gl_trans_intermediate.journal_header\nand gl_traansactions.journal_line_num=gl_trans_intermediate.journal_line_num\nleft join (select * from ${p_epsdl_db}.dim_gl_account_oracle_erp where w_data_src_id='ORACLE') account\non gl_trans_intermediate.account_code = account.oracle_natural_account and account.w_data_src_id='ORACLE'\nleft join (select * from ${p_epsdl_db}.dim_gl_company_oracle_erp where w_data_src_id='ORACLE')company \non gl_trans_intermediate.company_code=company.child_value and company.w_data_src_id='ORACLE'\nleft join (select * from ${p_epsdl_db}.dim_gl_vessel where w_data_src_id='ORACLE') vessel\non gl_trans_intermediate.vessel_code=vessel.vessel_code and vessel.w_data_src_id='ORACLE'\nleft join (select * from ${p_epsdl_db}.dim_gl_service where w_data_src_id='ORACLE')service\non gl_trans_intermediate.service_code=service.service_code and service.w_data_src_id='ORACLE' and service.integration_key != '00'\nleft join (select * from ${p_epsdl_db}.dim_gl_department where w_data_src_id='ORACLE') department\non gl_trans_intermediate.department_code=department.child_value and department.w_data_src_id='ORACLE' and department.integration_key != '000'\nleft join (select * from ${p_epsdl_db}.dim_gl_intercompany_oracle_erp where w_data_src_id='ORACLE') intercompany\non gl_trans_intermediate.intercompany_code=intercompany.intercompany_code and intercompany.w_data_src_id='ORACLE'\nleft join ${p_epsdl_db}.dim_gl_future1 future1\non gl_trans_intermediate.future1_code=future1.future1_code  and future1.w_data_src_id='ORACLE' and future1.integration_key != '000'\nleft join ${p_epsdl_db}.dim_gl_future2 future2\non gl_trans_intermediate.future2_code=future2.future2_code  and future2.w_data_src_id='ORACLE' and future2.integration_key != '0000'\nleft join ${p_epsdl_sri_db}.sri_oracle_gl_period period ON gl_traansactions.period_name = period.period_name \nand period.w_business_dt='${business_date}'\nand gl_traansactions.period_set_id=period.period_set_id\nwhere gl_traansactions.w_business_dt='${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'ORACLE'"
  incremental: false
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  soft_delete: false
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_gl_transactions_oracle_erp"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  merge_columns:
  - "accrual_type"
  - "document_date"
  - "document_type"
  - "our_company"
  - "from_to"
  - "serial_no"
  - "issue_date"
  - "place"
  - "name"
  - "due_date"
  - "currency"
  - "amount"
  - "book_value"
  - "vat_amount"
  - "vat_category"
  - "vat_number"
  - "inc_exp_category"
  - "inc_exp_group"
  - "document_subject"
  - "document_subsubject"
  - "document_category"
  - "transaction_type"
  - "journal_date"
  - "journal_status"
  - "journal_user"
  - "journal_posting"
  - "accrued_on_date"
  - "accrued_by_user"
  - "document_status"
  - "created_by_user"
  - "finalized_by_user"
  - "filed_to"
  - "bank"
  - "budget"
  - "open_item_status"
  - "matching_company"
  - "matching_series"
  - "matching_number"
  - "matching_line"
  - "debit_credit"
  - "remarks"
  - "operation_code1"
  - "operation_id1"
  - "operation_code2"
  - "operation_id2"
  - "allocation_date_from"
  - "allocation_date_to"
  - "entry_number"
  - "tot_local_debit"
  - "tot_local_credit"
  - "tot_book_debit"
  - "tot_book_credit"
  - "flag1"
  - "flag2"
  - "reporting_amount"
  - "set_currency_amount"
  - "approval_level"
  - "book_value_off"
  - "book_debit_off"
  - "book_credit_off"
  - "pay_flag"
  - "prt_flag"
  - "entry_rate"
  - "bunker_qty"
  - "bunker_price"
  - "application_code"
  - "application_ref"
  - "operation_subid_1"
  - "operation_subid_2"
  - "entry_rate2"
  - "book_value2"
  - "tot_book_debit2"
  - "tot_book_credit2"
  - "currency3"
  - "entry_rate3"
  - "book_value3"
  - "tot_book_debit3"
  - "tot_book_credit3"
  - "team"
  - "job_number"
  - "vessel_code"
  - "ar_type"
  - "approved_by"
  - "import_status"
  - "imported_by"
  - "sup_match"
  - "journal_user_2"
  - "accrued_by_user_2"
  - "created_by_user_2"
  - "finalized_by_user_2"
  - "flag3"
  - "order_number"
  - "supplier_code"
  - "last_updated"
  - "db_userid"
  - "fx_rate"
  - "mc_reference"
  - "spot_rate_flag"
  - "filed_to3"
  - "pay_approval_level"
  - "pay_selected"
  - "payment_method"
  - "withholding_tax_amount"
  - "instrument_no"
  - "withholding_tax_code"
  - "flag4"
  - "submission_date"
  - "value_date"
  - "transaction_cost"
  - "accrual_flag"
  - "order_code"
  - "document_code"
  - "internal_ref"
  - "company_id"
  - "vessel_id"
  - "service_id"
  - "account_id"
  - "department_id"
  - "intercompany_id"
  - "future1_id"
  - "future2_id"
  - "code_combination_id"
  - "journal_reference"
  - "journal_id"
  - "tot_global_credit"
  - "tot_global_debit"
  - "journal_company"
  - "journal_line"
  - "journal_number"
  - "journal_series"
  - "journal_narrative"
  - "delete_flag"
  - "ledger_id"
  - "je_source"
  endpoint: "lo_delta_tables"

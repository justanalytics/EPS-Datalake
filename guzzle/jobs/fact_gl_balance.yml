version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select \ndocuments.company_id,\ndocuments.account_id,\ndocuments.vessel_id,\ndocuments.service_id,\ndocuments.department_id,\ndocuments.intercompany_id,\ndocuments.future1_id,\ndocuments.future2_id,\ndocuments.ledger_id,\ncast(year(journal_date)||'-'||(case when month(journal_date)<10 then '0'||month(journal_date) else month(journal_date) end)||'-01' as date) as journal_period,\ncoalesce(company.child_value,'')||'~'||coalesce(vessel.vessel_code,'')||'~'||coalesce(service.service_code,'')||'~'||coalesce(account.oracle_natural_account,'')||'~'||coalesce(intercompany.intercompany_code,'')||'~'||coalesce(department.child_value,'')||'~'||coalesce(future1.future1_code,'')||'~'||coalesce(future2.future2_code,'')||'~DANAOS' as code_combination_id,\n(SUM(coalesce(tot_book_debit, 0)) - SUM(coalesce(tot_book_credit, 0))) balance,\nSUM(coalesce(tot_book_debit, 0)) as tot_book_debit,\nSUM(coalesce(tot_book_credit, 0)) as tot_book_credit,\n(SUM(coalesce(tot_local_debit, 0)) - SUM(coalesce(tot_local_credit, 0))) local_balance,\nsum(coalesce(tot_local_debit, 0)) as tot_local_debit,\nsum(coalesce(tot_local_credit, 0)) as tot_local_credit,\n'DANAOS' as source_system,\ndocuments.w_data_src_id\nfrom\n${p_epsdl_db}.fact_gl_transactions_danaos documents\nleft join\n(select * from ${p_epsdl_db}.dim_gl_vessel where w_data_src_id='MANUAL') vessel\non\ndocuments.vessel_id=vessel.vessel_id\nleft join\n(select * from ${p_epsdl_db}.dim_gl_account where w_data_src_id='MANUAL') account\non\ndocuments.account_id=account.account_id\nleft join\n(select * from ${p_epsdl_db}.dim_gl_company where w_data_src_id='MANUAL') company\non\ndocuments.company_id=company.company_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_service where w_data_src_id='MANUAL') service\non\nservice.service_id=documents.service_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_department where w_data_src_id='MANUAL')  department\non\ndepartment.department_id=DOCUMENTS.department_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_intercompany where w_data_src_id='MANUAL') intercompany\non\nintercompany.intercompany_id=DOCUMENTS.intercompany_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_future1 where w_data_src_id='MANUAL') future1\non\nfuture1.future1_id=DOCUMENTS.future1_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_future2 where w_data_src_id='MANUAL') future2\non\nfuture2.future2_id=DOCUMENTS.future2_id\nleft join\n${p_epsdl_db}.dim_period period\non\nperiod.date=documents.journal_date\nwhere \ndocuments.Journal_series NOT IN ('YC','QT','PD','QC','QS')  \nand  \ndocuments.delete_flag=0 \ngroup by\ndocuments.company_id,\ndocuments.account_id,\ndocuments.vessel_id,\ndocuments.service_id,\ndocuments.department_id,\ndocuments.intercompany_id,\ndocuments.future1_id,\ndocuments.future2_id,\ndocuments.ledger_id,\ndocuments.w_data_src_id,\ncast(year(journal_date)||'-'||(case when month(journal_date)<10 then '0'||month(journal_date) else month(journal_date) end)||'-01' as date),\ncoalesce(company.child_value,'')||'~'||coalesce(vessel.vessel_code,'')||'~'||coalesce(service.service_code,'')||'~'||coalesce(account.oracle_natural_account,'')||'~'||coalesce(intercompany.intercompany_code,'')||'~'||coalesce(department.child_value,'')||'~'||coalesce(future1.future1_code,'')||'~'||coalesce(future2.future2_code,'')||'~DANAOS'\n\nunion all \n\nselect \ndocuments.company_id,\ndocuments.account_id,\ndocuments.vessel_id,\ndocuments.service_id,\ndocuments.department_id,\ndocuments.intercompany_id,\ndocuments.future1_id,\ndocuments.future2_id,\ndocuments.ledger_id,\ndocuments.journal_date as journal_period,\ncoalesce(company.child_value,'')||'~'||coalesce(vessel.vessel_code,'')||'~'||coalesce(service.service_code,'')||'~'||coalesce(account.oracle_natural_account,'')||'~'||coalesce(intercompany.intercompany_code,'')||'~'||coalesce(department.child_value,'')||'~'||coalesce(future1.future1_code,'')||'~'||coalesce(future2.future2_code,'')||'~DANAOS' as code_combination_id,\n(SUM(coalesce(tot_book_debit, 0)) - SUM(coalesce(tot_book_credit, 0))) balance,\nSUM(coalesce(tot_book_debit, 0)) as tot_book_debit,\nSUM(coalesce(tot_book_credit, 0)) as tot_book_credit,\n(SUM(coalesce(tot_local_debit, 0)) - SUM(coalesce(tot_local_credit, 0))) local_balance,\nsum(coalesce(tot_local_debit, 0)) as tot_local_debit,\nsum(coalesce(tot_local_credit, 0)) as tot_local_credit,\n'ORACLE' as source_system,\ndocuments.w_data_src_id\nfrom\n${p_epsdl_db}.fact_gl_transactions_oracle_erp documents\nleft join\n(select * from ${p_epsdl_db}.dim_gl_vessel where w_data_src_id='ORACLE') vessel\non\ndocuments.vessel_id=vessel.vessel_id\nleft join\n(select * from ${p_epsdl_db}.dim_gl_account_oracle_erp where w_data_src_id='ORACLE') account\non\ndocuments.account_id=account.account_id\nleft join\n(select * from ${p_epsdl_db}.dim_gl_company_oracle_erp where w_data_src_id='ORACLE') company\non\ndocuments.company_id=company.company_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_service where w_data_src_id='ORACLE') service\non\nservice.service_id=documents.service_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_department  where w_data_src_id='ORACLE') department\non\ndepartment.department_id=DOCUMENTS.department_id\nleft join\n(select * from ${p_epsdl_db}.dim_gl_intercompany_oracle_erp where w_data_src_id='ORACLE') intercompany\non\nintercompany.intercompany_id=DOCUMENTS.intercompany_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_future1 where w_data_src_id='ORACLE') future1\non\nfuture1.future1_id=DOCUMENTS.future1_id\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_future2 where w_data_src_id='ORACLE') future2\non\nfuture2.future2_id=DOCUMENTS.future2_id\ngroup by\ndocuments.company_id,\ndocuments.account_id,\ndocuments.vessel_id,\ndocuments.service_id,\ndocuments.department_id,\ndocuments.intercompany_id,\ndocuments.future1_id,\ndocuments.future2_id,\ndocuments.ledger_id,\ndocuments.w_data_src_id,\ndocuments.journal_date,\ncoalesce(company.child_value,'')||'~'||coalesce(vessel.vessel_code,'')||'~'||coalesce(service.service_code,'')||'~'||coalesce(account.oracle_natural_account,'')||'~'||coalesce(intercompany.intercompany_code,'')||'~'||coalesce(department.child_value,'')||'~'||coalesce(future1.future1_code,'')||'~'||coalesce(future2.future2_code,'')||'~DANAOS'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
  incremental: false
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_gl_balance"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  endpoint: "lo_delta_tables"
  soft_delete: false

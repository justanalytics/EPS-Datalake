version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with mv_navi_audit_answers AS\n(\n    select audit_id,vessel_code,q_no,q_type,q_answer,w_job_instance_id,w_refresh_ts,w_source_system,w_location,w_batch_id\n    from ${p_epsdl_sri_db}.sri_nav_audit_off_answers\n    where w_business_dt='${business_date}'\n    union all\n    select audit_id,vessel_code,q_no,q_type,q_answer,w_job_instance_id,w_refresh_ts,w_source_system,w_location,w_batch_id\n    from ${p_epsdl_sri_db}.sri_nav_audit_vsl_answers \n    where q_type <> 'NAV_AUDIT_OFF'\n    and w_business_dt='${business_date}'\n)\nSELECT DISTINCT \n        a.id as audit_id\n        ,a.vessel_code\n        ,SUBSTR(i.serial_no,1,(instr(i.serial_no,'.')-1)) as chapter_no\n        ,COUNT(a.id) as ob_count2\n        ,COUNT(DISTINCT a.id||a.vessel_code) as req_count\n        ,case when g.department = 13 then 'OFFICE-TECH' when g.department = 21 then 'OFFICE-OPS' end as flag\n        ,coalesce(a.id,'')||'~'||coalesce(a.vessel_code,'')||'~'||coalesce(SUBSTR(i.serial_no,1,(instr(i.serial_no,'.')-1)),'')||'~'||case when g.department = 13 then 'OFFICE-TECH' when g.department = 21 then 'OFFICE-OPS' end as integration_key\n        ,null as w_x_custom\n        ,a.w_job_instance_id\n        ,a.w_refresh_ts\n        ,null as w_curr_rec_flg\n        ,a.w_source_system as w_data_src_id\n        ,a.w_location\n        ,a.w_batch_id\n        ,'${business_date}' as business_date \nFROM ${p_epsdl_sri_db}.sri_insp_inspection a\n\njoin ${p_epsdl_sri_db}.sri_insp_inspection_questionnaire c\n        on a.id = c.inspection_id\n        and c.w_business_dt='${business_date}'\n\njoin ${p_epsdl_sri_db}.sri_insp_answer b\n        on c.insp_answer_id = b.id\n        and b.w_business_dt='${business_date}'\n\njoin ${p_epsdl_sri_db}.sri_insp_questionnaire_question e\n        on c.insp_questionnaire_question_id = e.id\n        and e.w_business_dt='${business_date}'\n\njoin ${p_epsdl_sri_db}.sri_insp_questionnaire_category f\n        on e.questionnaire_category_id = f.id\n        and f.w_business_dt='${business_date}'\n\njoin ${p_epsdl_sri_db}.sri_insp_questionnaire g\n        on f.questionnaire_id = g.id\n        and g.w_business_dt='${business_date}'\n\njoin ${p_epsdl_sri_db}.sri_insp_category h\n        on f.category_id = h.id\n        and h.w_business_dt='${business_date}'\n\njoin ${p_epsdl_sri_db}.sri_insp_question i\n        on e.question_id = i.id\n        and i.w_business_dt='${business_date}'\n\nWHERE b.id = 4\nAND g.department in (13,21)\nand a.w_business_dt='${business_date}'\nGROUP BY a.id\n        ,a.vessel_code\n        ,SUBSTR(i.serial_no,1,(instr(i.serial_no,'.')-1))\n        ,case when g.department = 13 then 'OFFICE-TECH' when g.department = 21 then 'OFFICE-OPS' end\n        ,coalesce(a.id,'')||'~'||coalesce(a.vessel_code,'')||'~'||coalesce(SUBSTR(i.serial_no,1,(instr(i.serial_no,'.')-1)),'')||'~'||case when g.department = 13 then 'OFFICE-TECH' when g.department = 21 then 'OFFICE-OPS' end\n        ,a.w_job_instance_id\n        ,a.w_refresh_ts\n        ,a.w_source_system\n        ,a.w_location\n        ,a.w_batch_id\n        ,'${business_date}'\n   \nunion all \n  \nSELECT DISTINCT \n        a.audit_id\n        ,a.vessel_code\n        ,cast(b.q_cat_sort_no as string) as chapter_no\n        ,COUNT(a.q_Answer) as ob_count2\n        ,COUNT(DISTINCT a.audit_id||a.vessel_code) as req_count\n        ,'MASTER' as flag\n        ,coalesce(a.audit_id,'')||'~'||coalesce(a.vessel_code,'')||'~'||coalesce(b.q_cat_sort_no,'')||'~'||'MASTER' as integration_key\n        ,null as w_x_custom\n        ,a.w_job_instance_id\n        ,a.w_refresh_ts\n        ,null as w_curr_rec_flg\n        ,a.w_source_system as w_data_src_id\n        ,a.w_location\n        ,a.w_batch_id\n        ,'${business_date}' as business_date \nFROM mv_navi_audit_answers a\njoin ${p_epsdl_sri_db}.sri_nav_audit_qn_master b \n        on a.q_no=b.q_no\n        and b.w_business_dt='${business_date}'\nWHERE trim(a.q_type) LIKE '%VSL%'\n        AND a.q_answer='No'\nGROUP BY a.audit_id\n        ,a.vessel_code\n        ,cast(b.q_cat_sort_no as string)\n        ,'MASTER'\n        ,coalesce(a.audit_id,'')||'~'||coalesce(a.vessel_code,'')||'~'||coalesce(b.q_cat_sort_no,'')||'~'||'MASTER'\n        ,a.w_job_instance_id\n        ,a.w_refresh_ts\n        ,a.w_source_system\n        ,a.w_location\n        ,a.w_batch_id\n        ,'${business_date}'\n\nunion all     \n    \nSELECT distinct \n        request_id as audit_id\n        ,vessel_code\n        ,SUBSTR(b.question_number,1,(instr(b.question_number,'.')-1)) as chapter_no\n        ,COUNT(deficiency) ob_count1\n        ,count(distinct Request_id) req_Count\n        ,'MOC' as flag\n        ,coalesce(request_id,'')||'~'||coalesce(vessel_code,'')||'~'||coalesce(SUBSTR(b.question_number,1,(instr(b.question_number,'.')-1)),'')||'~'||'MOC' as integration_key\n        ,null as w_x_custom\n        ,a.w_job_instance_id\n        ,a.w_refresh_ts\n        ,null as w_curr_rec_flg\n        ,a.w_source_system as w_data_src_id\n        ,a.w_location\n        ,a.w_batch_id\n        ,'${business_date}' as business_date \nFROM ${p_epsdl_sri_db}.sri_moc_deficiencies a\njoin ${p_epsdl_sri_db}.sri_moc_viq_questions b\n        on a.section = b.question_number\n        and b.w_business_dt='${business_date}'\nwhere a.w_business_dt='${business_date}'\ngroup by request_id\n        ,SUBSTR(b.question_number,1,(instr(b.question_number,'.')-1))\n        ,vessel_code\n        ,'MOC'\n        ,coalesce(request_id,'')||'~'||coalesce(vessel_code,'')||'~'||coalesce(SUBSTR(b.question_number,1,(instr(b.question_number,'.')-1)),'')||'~'||'MOC'\n        ,a.w_job_instance_id\n        ,a.w_refresh_ts\n        ,a.w_source_system\n        ,a.w_location\n        ,a.w_batch_id\n        ,'${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'VLOG'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_insp_moc_nav_obser_inspec"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "SELECT period\n\t,vessel_code\n\t,count(*) AS shipdays\nFROM (\n\tSELECT last_day(p.DATE) AS period\n        ,v.vessel_code\n\tFROM ${p_epsdl_db}.dim_gl_vessel v\n\tJOIN ${p_epsdl_db}.dim_period p ON p.DATE BETWEEN coalesce(v.START_DATE, date_add(last_day(add_months(current_date(), -1)),1) )\n\t\t\tAND coalesce(v.SOLD_DATE, to_date('2021-12-31', 'yyyy-MM-dd') )\n\tWHERE w_data_src_id = 'ORACLE'\n\t)\nGROUP BY period\n    ,vessel_code"
  incremental: false
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_sri_db}.tmp_sri_oracle_ship_days"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  endpoint: "lo_delta_tables"
  soft_delete: false

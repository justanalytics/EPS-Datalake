version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select * from\n(\nselect\nsri_imos_port_call.agreed_speed,\nnull as Agreed_Speed_A,\nnull as Agreed_Speed_D,\nnull as Agreed_Speed_O,\nsri_imos_port_call.agreed_speed_cons,\nnull as agreed_speed_cons_A,\nnull as agreed_speed_cons_D,\nnull as agreed_speed_cons_O,\nsri_imos_port_call.agreed_speed_engine_load,\nnull as agreed_speed_engine_load_A,\nnull as agreed_speed_engine_load_D,\nnull as agreed_speed_engine_load_O,\nsri_imos_port_call.anchorage_delay,\nsri_imos_port_call.arr_dep_status,\nsri_imos_port_call.arrival_local,\nsri_imos_port_call.ballast_laden_from_port,\nsri_imos_port_call.ballast_laden_to_port,\nnull as Ballast_Laden_to_Port_A,\nnull as Ballast_Laden_to_Port_D,\nnull as Ballast_Laden_to_Port_O,\nsri_imos_port_call.berth_to_pilot,\nsri_imos_port_call.cargo_inspector,\nsri_imos_port_call.cargo_scheduler,\nsri_imos_port_call.dem_des_days,\nsri_imos_port_call.dem_des_rate,\nsri_imos_port_call.departure_local,\nsri_imos_port_call.est_cost_base,\nsri_imos_port_call.eta_gmt,\nsri_imos_port_call.etb,\nsri_imos_port_call.etd_gmt,\nsri_imos_port_call.extra_port_days,\nsri_imos_port_call.extra_sea_days,\nsri_imos_port_call.fixture_no,\nsri_imos_port_call.idle_days,\nsri_imos_port_call.instructed_sat_local,\nsri_imos_port_call.instructed_speed,\nnull as Instructed_Speed_A,\nnull as Instructed_Speed_D,\nnull as Instructed_Speed_O,\nsri_imos_port_call.is_current_port_call,\nsri_imos_port_call.last_update_gmt,\nsri_imos_port_call.last_user_id,\nsri_imos_port_call.low_speed_days,\nsri_imos_port_call.low_speed_miles,\nsri_imos_port_call.ls_miles,\nsri_imos_port_call.ls_port_days,\nsri_imos_port_call.ls_sea_days,\nsri_imos_port_call.master_seq,\nsri_imos_port_call.miles,\nsri_imos_port_call.order,\nsri_imos_port_call.pilot_to_berth,\nsri_imos_port_call.port_days,\nsri_imos_port_call.port_exp_amount_base,\nsri_imos_port_call.port_exp_amount_local,\nsri_imos_port_call.port_exp_curr,\nsri_imos_port_call.port_exp_exch_rate,\nsri_imos_port_call.port_func,\nsri_imos_port_call.port_name,\nsri_imos_port_call.port_no,\nsri_imos_port_call.port_status_code,\nsri_imos_port_call.sea_days,\nsri_imos_port_call.seq,\nsri_imos_port_call.speed_from_port,\nsri_imos_port_call.speed_instruction_type,\nsri_imos_port_call.speed_to_port,\nsri_imos_port_call.vessel_code,\nsri_imos_port_call.via,\nsri_imos_port_call.voyage_no,\nsri_imos_port_call.weather_factor_from_port,\nsri_imos_port_call.weather_factor_to_port,\nsri_imos_port_call.remarks_fixture,\nsri_imos_port_call.remarks_operations,\nsri_imos_port_call.un_code,\nsri_imos_port_call.country,\nsri_imos_port_call.area,\nsri_imos_port_call.port_range,\nsri_imos_port_call.port_region,\nsri_imos_port_call.low_sulfur_eca,\nsri_imos_port_call.name,\nsri_imos_port_call.latitude,\nsri_imos_port_call.longitude,\nsri_imos_port_call.integration_key,\nsri_imos_port_call.w_source_system as w_data_src_id,\nsri_imos_port_call.w_refresh_ts,\nsri_imos_port_call.w_job_instance_id,\nsri_imos_port_call.w_business_dt as business_date,\nsri_imos_port_call.w_location,\nsri_imos_port_call.w_batch_id,\nnull as w_x_custom,\nnull as w_curr_rec_flg,\ndim_gl_vessel.vessel_id,\nnull as telegram_date_A,\nnull as telegram_date_D,\nnull as telegram_date_O,\nnull as telegram_type_A,\nnull as telegram_type_D,\nnull as telegram_type_O,\n'1900-01-01' as exp_ref,\nrow_number() over(partition by sri_imos_port_call.vessel_code,sri_imos_port_call.voyage_no,sri_imos_port_call.seq order by sri_imos_port_call.w_business_dt desc) as rownum\nfrom \n${p_epsdl_sri_db}.sri_imos_port_call sri_imos_port_call\nleft join\n(select * from ${p_epsdl_db}.dim_gl_vessel where w_data_src_id='MANUAL') dim_gl_vessel\non\nsri_imos_port_call.vessel_code=dim_gl_vessel.vessel_code\nwhere \nsri_imos_port_call.w_business_dt='${business_date}' \n) where rownum=1"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
  incremental: false
target:
  primary_key_columns:
  - "vessel_code"
  - "voyage_no"
  - "seq"
  - "w_data_src_id"
  operation: "merge"
  soft_delete: false
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_port_calls_imos"
  merge_columns:
  - "agreed_speed"
  - "agreed_speed_cons"
  - "agreed_speed_engine_load"
  - "anchorage_delay"
  - "arr_dep_status"
  - "arrival_local"
  - "ballast_laden_from_port"
  - "ballast_laden_to_port"
  - "berth_to_pilot"
  - "cargo_inspector"
  - "cargo_scheduler"
  - "dem_des_days"
  - "dem_des_rate"
  - "departure_local"
  - "est_cost_base"
  - "eta_gmt"
  - "etb"
  - "etd_gmt"
  - "extra_port_days"
  - "extra_sea_days"
  - "fixture_no"
  - "idle_days"
  - "instructed_sat_local"
  - "instructed_speed"
  - "is_current_port_call"
  - "last_update_gmt"
  - "last_user_id"
  - "low_speed_days"
  - "low_speed_miles"
  - "ls_miles"
  - "ls_port_days"
  - "ls_sea_days"
  - "master_seq"
  - "miles"
  - "order"
  - "pilot_to_berth"
  - "port_days"
  - "port_exp_amount_base"
  - "port_exp_amount_local"
  - "port_exp_curr"
  - "port_exp_exch_rate"
  - "port_func"
  - "port_name"
  - "port_no"
  - "port_status_code"
  - "sea_days"
  - "speed_from_port"
  - "speed_instruction_type"
  - "speed_to_port"
  - "via"
  - "weather_factor_from_port"
  - "weather_factor_to_port"
  - "remarks_fixture"
  - "remarks_operations"
  - "un_code"
  - "country"
  - "area"
  - "port_range"
  - "port_region"
  - "low_sulfur_eca"
  - "name"
  - "vessel_id"
  - "w_data_src_id"
  - "latitude"
  - "longitude"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "\nselect\n\t\tperiod.date_id\n        ,coalesce(dim_gl_company.company_id,'0000') as company_id\n\t\t,coalesce(dim_gl_vessel .vessel_id, '0000') AS vessel_id\n\t\t,coalesce(dim_gl_service.service_id, '00') AS service_id\n\t\t,coalesce(dim_gl_department.department_id, '000') AS department_id\n\t\t,coalesce(account.account_id, '000000') AS account_id\n\t\t,coalesce(dim_gl_intercompany.intercompany_id, '0000') AS intercompany_id\n\t\t,coalesce(future1.future1_id, '000') AS future1_id\n\t\t,coalesce(future2.future2_id, '0000') AS future2_id\n\n\t\t,coalesce(dim_gl_company.child_value, '') || '~' || coalesce(dim_gl_vessel.vessel_code, '') || '~' || coalesce(dim_gl_service.service_code, '') || '~' || coalesce(account.oracle_natural_account, '') || '~' || coalesce(dim_gl_intercompany.intercompany_code, '') || '~' || coalesce(dim_gl_department.child_value, '') || '~' || coalesce(future1.future1_code, '') || '~' || coalesce(future2.future2_code, '') as code_combination_id\n\t\t\n\t\t,sri_balance.BUDGET_VERSION_ID\n\t\t,sri_balance.ACTUAL_FLAG\n\t\t,sri_balance.PERIOD_NET_DR / tmp_ship_days.SHIPDAYS as DAILY_PERIOD_NET_DR\n\t\t,sri_balance.PERIOD_NET_CR / tmp_ship_days.SHIPDAYS as DAILY_PERIOD_NET_CR\n\t\t,sri_balance.DEBIT_BALANCE / tmp_ship_days.SHIPDAYS as DAILY_DEBIT_BALANCE\n\t\t,sri_balance.CREDIT_BALANCE / tmp_ship_days.SHIPDAYS as DAILY_CREDIT_BALANCE\n\n\t\t,tmp_ship_days.SHIPDAYS\n\t\t,sri_balance.PERIOD_NET_DR\n\t\t,sri_balance.PERIOD_NET_CR\n\t\t,sri_balance.DEBIT_BALANCE\n\t\t,sri_balance.CREDIT_BALANCE\n\t\t,sri_balance.integration_key\n\t\t,sri_balance.ledger_id\n\t\t,account.ledger_card\n\t\t\n/*      ,dim_gl_company.child_value as company_code\t\n      ,dim_gl_vessel.vessel_code\n      ,dim_gl_service.service_code\n      ,dim_gl_department.child_value as department_code\n\t\t,account.oracle_natural_account as account_code\n\t\t,dim_gl_intercompany.intercompany_code\n\t\t,future1.future1_code\n\t\t,future2.future2_code\n\t\t,'${business_date}' as business_date\n*/\nFROM ${p_epsdl_sri_db}.sri_oracle_fact_gl_balance sri_balance\n\nJOIN ${p_epsdl_sri_db}.sri_oracle_gl_account gl_account ON sri_balance.code_combination_id = gl_account.code_combination_id\n\tAND gl_account.w_business_dt = '${business_date}'\n\nJOIN ( /* company   */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59001'\n\t) AS sri_company ON sri_company.segment_code = gl_account.segment1\n\tAND sri_company.w_business_dt = '${business_date}'\nLEFT JOIN (\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_company WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_company ON dim_gl_company.child_value = sri_company.segment_code\n\tAND dim_gl_company.w_data_src_id = 'ORACLE'\n\nJOIN ( /* vessel  */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59002'\n\t) AS sri_vessel ON sri_vessel.segment_code = gl_account.segment2\n\tAND sri_vessel.w_business_dt = '${business_date}'\nLEFT JOIN (\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_vessel WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_vessel ON dim_gl_vessel.vessel_code = sri_vessel.segment_code\n\tAND dim_gl_vessel.w_data_src_id = 'ORACLE'\n\nJOIN ( /* service */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59003'\n\t) AS sri_service ON sri_service.segment_code = gl_account.segment3\n\tAND sri_service.w_business_dt = '${business_date}'\nLEFT JOIN (\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_service WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_service ON dim_gl_service.service_code = sri_service.segment_code\n\tAND dim_gl_service.w_data_src_id = 'ORACLE'\n\tAND dim_gl_service.integration_key != '00'\n\nJOIN ( /* department */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59004'\n\t) AS sri_department ON sri_department.segment_code = gl_account.segment4\n\tAND sri_department.w_business_dt = '${business_date}'\nLEFT JOIN (\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_department WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_department ON dim_gl_department.child_value = sri_department.segment_code\n\tAND dim_gl_department.w_data_src_id = 'ORACLE'\n\tAND dim_gl_department.integration_key != '000'\n\t\nJOIN ( /* natural account */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59005'\n\t) AS natural_account ON natural_account.segment_code = gl_account.segment5\n\tAND natural_account.w_business_dt = '${business_date}'\nLEFT JOIN (\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_account_oracle_erp WHERE w_data_src_id = 'ORACLE'\n\t) account ON account.oracle_natural_account = natural_account.segment_code\n\tAND account.w_data_src_id = 'ORACLE'\n\nJOIN ( /* intercompany */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59006'\n\t) AS sri_intercompany ON sri_intercompany.segment_code = gl_account.segment6\n\tAND sri_intercompany.w_business_dt = '${business_date}'\nLEFT JOIN (\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_intercompany WHERE w_data_src_id = 'ORACLE'\n\t) AS dim_gl_intercompany ON dim_gl_intercompany.intercompany_code = sri_intercompany.segment_code\n\tAND dim_gl_intercompany.w_data_src_id = 'ORACLE'\n\nJOIN ( /* future1 */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59007'\n\t) AS sri_future1 ON sri_future1.segment_code = gl_account.segment7\n\tAND sri_future1.w_business_dt = '${business_date}'\nLEFT JOIN ${p_epsdl_db}.dim_gl_future1 future1 ON future1.future1_code = sri_future1.segment_code\n\tAND future1.w_data_src_id = 'ORACLE'\n\tAND future1.integration_key != '000'\n\nJOIN ( /* future2 */\n\n\tSELECT * FROM ${p_epsdl_sri_db}.sri_oracle_gl_segment WHERE segment_lov_id = '59008'\n\t) AS sri_future2 ON sri_future2.segment_code = gl_account.segment8\n\tAND sri_future2.w_business_dt = '${business_date}'\nLEFT JOIN ${p_epsdl_db}.dim_gl_future2 future2 ON future2.future2_code = sri_future2.segment_code\n\tAND future2.w_data_src_id = 'ORACLE'\n\tAND future2.integration_key != '000'\t\n\t\nJOIN ${p_epsdl_sri_db}.tmp_sri_oracle_ship_days tmp_ship_days\n    ON tmp_ship_days.vessel_code = dim_gl_vessel.vessel_code\n\tAND tmp_ship_days.period = cast(sri_balance.end_date as date)\n\t\nJOIN ${p_epsdl_db}.dim_period period \n    ON period.date BETWEEN coalesce(dim_gl_vessel.START_DATE, current_date()) \n              and coalesce(dim_gl_vessel.SOLD_DATE , last_day(current_date()))\n    AND tmp_ship_days.period between date_add(last_day(add_months(period.date, -1)),1) and last_day(period.date)\n\nwhere sri_balance.w_business_dt = '${business_date}'\n\tand sri_balance.ACTUAL_FLAG = 'B'\n\n"
  incremental: false
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'ORACLE'"
  - name: "w_data_src_id"
    value: "'ORACLE'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_gl_budget_oracle"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  endpoint: "lo_delta_tables"
  soft_delete: false

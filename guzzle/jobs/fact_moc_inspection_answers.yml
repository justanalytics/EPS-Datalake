version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with mv_navi_audit_answers AS\n(\n    select audit_id,vessel_code,q_no,q_type,q_answer,w_job_instance_id,w_refresh_ts,w_source_system,w_location,w_batch_id\n    from ${p_epsdl_sri_db}.sri_nav_audit_off_answers\n    where w_business_dt='${business_date}'\n    union all\n    select audit_id,vessel_code,q_no,q_type,q_answer,w_job_instance_id,w_refresh_ts,w_source_system,w_location,w_batch_id\n    from ${p_epsdl_sri_db}.sri_nav_audit_vsl_answers \n    where q_type <> 'NAV_AUDIT_OFF'\n    and w_business_dt='${business_date}'\n)\nSELECT distinct \n    request_id as audit_id\n    ,vessel_code\n    ,b.chapter as chapter_name\n    ,COUNT(deficiency) as ob_count1\n    ,count(distinct Request_id) as req_count\n    ,'MOC' as flag\n    ,coalesce(request_id,'')||'~'||coalesce(vessel_code,'')||'~'||coalesce(b.chapter,'')||'~'||'MOC' as integration_key\n    ,null as w_x_custom\n    ,a.w_job_instance_id\n    ,a.w_refresh_ts\n    ,null as w_curr_rec_flg\n    ,a.w_source_system as w_data_src_id\n    ,a.w_location\n    ,a.w_batch_id\n    ,'${business_date}' as business_date \n  FROM ${p_epsdl_sri_db}.sri_moc_deficiencies a\n  JOIN ${p_epsdl_sri_db}.sri_moc_viq_questions b\n  on a.section = b.question_number\n  and b.w_business_dt='${business_date}'\n  where a.w_business_dt='${business_date}'\n  GROUP BY \n    request_id\n    ,b.chapter\n    ,vessel_code\n    ,'MOC'\n    ,a.w_job_instance_id\n    ,a.w_refresh_ts\n    ,a.w_source_system\n    ,a.w_location\n    ,a.w_batch_id\n    ,'${business_date}'\n  UNION ALL\n  SELECT distinct \n    a.audit_id as audit_id\n    ,a.vessel_code as vessel_Code\n    ,b.q_category as chapter_name\n    ,COUNT(a.q_answer) as ob_count1\n    ,count (distinct a.audit_id||a.vessel_Code) as req_count\n    ,a.q_type as flag\n    ,coalesce(a.audit_id,'')||'~'||coalesce(a.vessel_code,'')||'~'||coalesce(b.q_category,'')||'~'||coalesce(a.q_type,'') as integration_key\n    ,null as w_x_custom\n    ,a.w_job_instance_id\n    ,a.w_refresh_ts\n    ,null as w_curr_rec_flg\n    ,a.w_source_system as w_data_src_id\n    ,a.w_location\n    ,a.w_batch_id\n    ,'${business_date}' as business_date \n  FROM mv_navi_audit_answers a\n  JOIN ${p_epsdl_sri_db}.sri_nav_audit_qn_master b\n  ON a.q_no=b.q_no\n  AND b.q_type LIKE 'SIRE%'\n  AND a.q_type LIKE 'SIRE%'\n  AND a.q_answer='No'\n  AND b.w_business_dt='${business_date}'\n  GROUP BY \n    a.audit_id\n    ,a.vessel_code\n    ,b.q_category\n    ,a.q_type\n    ,a.w_job_instance_id\n    ,a.w_refresh_ts\n    ,a.w_source_system\n    ,a.w_location\n    ,a.w_batch_id\n    ,'${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'APPLN1'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_moc_inspection_answers"
  endpoint: "lo_delta_tables"

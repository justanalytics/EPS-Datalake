version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\nvessel_total.vessel_code as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct vessel_code from ${p_epsdl_db}.dim_gl_vessel) vessel_total\non \nsecurity.level='TOTAL'\nand\nsecurity.dimension='VESSEL'\nwhere \nsecurity.w_business_dt='${business_date}'\nunion all\nselect\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\nvessel_fleet.vessel_code as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct vessel_code,fleet from ${p_epsdl_db}.dim_gl_vessel) vessel_fleet\non \nsecurity.level='FLEET'\nand\nsecurity.dimension='VESSEL'\nand \nsecurity.value=vessel_fleet.fleet\nwhere \nsecurity.w_business_dt='${business_date}'\nunion all\nselect\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\nvessel_fleet_type.vessel_code as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct vessel_code,fleet,fleet_type from ${p_epsdl_db}.dim_gl_vessel) vessel_fleet_type\non \nsecurity.level='FLEET_TYPE'\nand \nsecurity.value=vessel_fleet_type.fleet_type\nand\nsecurity.dimension='VESSEL'\nwhere \nsecurity.w_business_dt='${business_date}'\nunion all\nselect\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\nvessel_fleet_type_sub.vessel_code as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct vessel_code,fleet,fleet_type,fleet_type_sub from ${p_epsdl_db}.dim_gl_vessel) vessel_fleet_type_sub\non \nsecurity.level='FLEET_TYPE_SUB'\nand \nsecurity.value=vessel_fleet_type_sub.fleet_type_sub\nand\nsecurity.dimension='VESSEL'\nwhere \nsecurity.w_business_dt='${business_date}'\nunion all\nselect\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\nvessel.vessel_code as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct vessel_code,fleet_code,fleet_type_code,fleet_type_sub_code from ${p_epsdl_db}.dim_gl_vessel) vessel\non \nsecurity.level='VESSEL'\nand \nsecurity.value=vessel.vessel_code\nand\nsecurity.dimension='VESSEL'\nwhere \nsecurity.w_business_dt='${business_date}'\nunion all\nselect\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\ncompany.child_value as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct child_value from ${p_epsdl_db}.dim_gl_company) company\non \nsecurity.level='TOTAL'\nand\nsecurity.dimension='COMPANY'\nwhere \nsecurity.w_business_dt='${business_date}'\nunion all\nselect\nsecurity.email_address,\nsecurity.dimension,\nsecurity.level,\nsecurity.value as level_code,\ncompany.child_value as code,\nsecurity.integration_key,\nnull as w_x_custom,\nsecurity.w_job_instance_id,\nsecurity.w_refresh_ts,\nnull as w_curr_rec_flg,\nsecurity.w_source_system as w_data_src_id,\nsecurity.w_location,\nsecurity.w_batch_id,\n'${business_date}' as business_date\nfrom\n${p_epsdl_sri_db}.sri_data_security security\ncross join\n(select distinct danaos_co_code,child_value from ${p_epsdl_db}.dim_gl_company) company\non \nsecurity.level='COMPANY'\nand \nsecurity.value=company.child_value\nand\nsecurity.dimension='COMPANY'\nwhere \nsecurity.w_business_dt='${business_date}'\n"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_data_security"
  endpoint: "lo_delta_tables"

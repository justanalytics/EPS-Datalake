version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select\ndim_requisitions.DOCUMENT_CODE,\ndim_requisitions.BUYER_COMMENTS,\ndim_requisitions.COMMENTS,\ncase  when dim_requisitions.APPROVER is null then 'N' else 'Y' end as approver_flag ,\ndim_requisitions.DOCUMENT_NO,\ndim_requisitions.REQUISITION_CODE,\ndim_requisitions.ORDER_SUPPLIER,\ndim_requisitions.ORDER_CODE,\ndim_requisitions.ORDER_DATE,\ndim_requisitions.DOCUMENT_DATE,\ndim_requisitions.DISPUTED_COMMENTS,\ndim_requisitions.DISPUTED_DATE,\ndim_requisitions.DISPUTED_FLAG,\ndim_requisitions.APPROVER,\ndim_requisitions.USER,\ndim_requisitions.LINE_TYPE,\ndim_requisitions.QUOTATION_SUPPLIER,\ncase dim_requisitions.LINE_TYPE when 'R' then 'REQUISITIONS' when 'Q' then 'QUOTATION' when 'O' then 'PURCHASEORDER' when 'SO' then 'SPOTORDER' when 'D' then 'DELIVERYORDER' when 'I' then 'INVOICE' else 'OTHERS' end as line_type_description,\nDim_Supply_Items.ORDER_PRICE,\nDim_Supply_Items.ITEM_INTERN_REF,\nDim_Supply_Items.ORDER_QTY,\nDim_Supply_Items.ORDER_RATE,\nDim_Supply_Items.ORDER_DISCOUNT,\nDim_Supply_Items.PARCIAL,\nDim_Supply_Items.INVOICE_PRICE,\nDim_Supply_Items.INVOICE_QTY,\nDim_Supply_Items.INVOICE_RATE,\nDim_Supply_Items.INVOICE_DISCOUNT as Dim_Supply_Items_INVOICE_DISCOUNT,\nDim_Supply_Items.DELIVERD_QTY,\nDim_Supply_Items.ORDER_CURRENCY,\nFact_Quoted_Price.QUOTED_PRICE,\nFact_Quoted_Price.QUOTED_QTY,\nFact_Quoted_Price.QUOTED_RATE,\nFact_Quoted_Price.QUOTED_DISCOUNT,\nFact_Suppplier_Invoicing.STATUS,\nFact_Suppplier_Invoicing.ADDN_PACKING_COST,\nFact_Suppplier_Invoicing.ADDN_FORWARDING_COST,\nFact_Suppplier_Invoicing.INVOICE_AMOUNT,\nFact_Suppplier_Invoicing.CURRENCY,\nFact_Suppplier_Invoicing.INVOICE_DATE,\nFact_Suppplier_Invoicing.INVOICE_DISCOUNT as Fact_Suppplier_Invoicing_INVOICE_DISCOUNT,\nFact_Suppplier_Invoicing.INVOICE_NO,\ndim_requisitions.integration_key,\nnull as w_x_custom,\ndim_requisitions.w_job_instance_id,\ndim_requisitions.w_refresh_ts,\nnull as w_curr_rec_flg,\ndim_requisitions.w_data_src_id,\ndim_requisitions.w_location,\ndim_requisitions.w_batch_id,\n,'${business_date[0..9]}' as business_date\nfrom \n${p_epsdl_db}.dim_requisitions dim_requisitions\nleft join\n${p_epsdl_db}.Dim_Supply_Items Dim_Supply_Items\non\ndim_requisitions.DOCUMENT_CODE=Dim_Supply_Items.DOCUMENT_CODE\nleft join \n${p_epsdl_db}.fact_supplier_invoicing Fact_Suppplier_Invoicing\non\ndim_requisitions.ORDER_CODE=Fact_Suppplier_Invoicing.ORDER_CODE\nand\ndim_requisitions.ORDER_SUPPLIER=Fact_Suppplier_Invoicing.ORDER_SUPPLIER\nleft join\n${p_epsdl_db}.Fact_Quoted_Price Fact_Quoted_Price\non\ndim_requisitions.QUOTATION_SUPPLIER=Fact_Quoted_Price.SUPPLIER_CODE\nand\ndim_requisitions.DOCUMENT_CODE=Fact_Quoted_Price.DOCUMENT_CODE"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
target:
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_requisition"
  endpoint: "lo_delta_tables"
  primary_key_columns:
  - "integration_key"

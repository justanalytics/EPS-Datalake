version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "\nselect\n        sri_supply_items.DOCUMENT_CODE,\n        sri_supply_items.ITEM_SERIAL_NO,\n        sri_supply_items.INVOICE_CODE,\n        sri_supply_items.PARCIAL,\n        sri_supply_items.ORDER_PRICE,\n        sri_supply_items.ORDER_QTY,\n        sri_supply_items.ORDER_RATE,\n        sri_supply_items.ORDER_DISCOUNT,\n        sri_supply_items.INVOICE_PRICE,\n        sri_supply_items.INVOICE_QTY,\n        sri_supply_items.INVOICE_RATE,\n        sri_supply_items.INVOICE_DISCOUNT,\n        sri_supply_items.ITEM_SHORT_DESC,\n        sri_supply_items.ORDER_CURRENCY,\n\n        sri_supplier_invoicing.INVOICE_AMOUNT,\n        sri_supplier_invoicing.ADDN_PACKING_COST,\n        sri_supplier_invoicing.ADDN_FORWARDING_COST,\n        sri_supplier_invoicing.INVOICE_DISCOUNT as SUPPLIER_INVOICE_DISCOUNT,\n        sri_supplier_invoicing.STATUS,\n        sri_supplier_invoicing.CURRENCY,\n        sri_supplier_invoicing.INVOICE_NO,\n        sri_supplier_invoicing.INVOICE_DATE,\n\n        dim_requisitions.ORDER_CODE,\n        dim_requisitions.VESSEL_CODE,\n        dim_requisitions.DEPARTMENT,\n        dim_requisitions.DOCUMENT_NO,\n        dim_requisitions.LINE_TYPE,\n        dim_requisitions.ORDER_SUPPLIER,\n        dim_requisitions.DOCUMENT_DATE,\n        dim_requisitions.COMMENTS,\n        dim_requisitions.REQUISITION_CODE,\n\n        sri_order_details.DELIVERY_DATE,\n        sri_order_details.DELIVERY_PORT,\n        sri_order_details.PO_DESCRIPTION,\n\n        dim_department.department_id,\n        dim_gl_vessel.vessel_id,\n        dim_supplier.supplier_id,\n        dim_requisitions.requisition_id,\n        coalesce(sri_supply_items.document_code,'')||'~'||coalesce(sri_supply_items.item_serial_no,'')||'~'||coalesce(sri_supply_items.invoice_code,'')||'~'||coalesce(dim_requisitions.order_code,'')||'~'||coalesce(sri_supply_items.parcial,'')||'~'||coalesce(dim_requisitions.vessel_code,'')||'~'||coalesce(dim_requisitions.department,'')||'~'||coalesce(dim_requisitions.document_no,'')||'~'||coalesce(dim_requisitions.line_type,'')||'~'||coalesce(dim_requisitions.order_supplier,'')||'~'||coalesce(sri_supplier_invoicing.invoice_no,'')||'~'||coalesce(sri_supplier_invoicing.invoice_date,'') as integration_key\n\n        ,sri_supply_items.w_source_system as w_data_src_id\n        ,sri_supply_items.w_business_dt\n        ,sri_supply_items.w_refresh_ts\n        ,sri_supply_items.w_job_instance_id\n        ,sri_supply_items.w_location\n        ,sri_supply_items.w_batch_id\n        ,null as w_x_custom\n        ,null as w_curr_rec_flg\n\nfrom epsdlsrid.sri_supply_items sri_supply_items\n\njoin epsdld.dim_requisitions dim_requisitions\n        on sri_supply_items.DOCUMENT_CODE = dim_requisitions.DOCUMENT_CODE\n\njoin epsdld.dim_gl_vessel dim_gl_vessel\n        on dim_requisitions.VESSEL_CODE = dim_gl_vessel.VESSEL_CODE\n\njoin epsdld.dim_department dim_department\n        on dim_requisitions.DEPARTMENT = dim_department.CODE\n\nleft join epsdld.dim_supplier dim_supplier\n        on dim_requisitions.ORDER_SUPPLIER = dim_supplier.SUPPLIER_CODE\n\nleft join epsdlsrid.sri_supplier_invoicing sri_supplier_invoicing\n        on sri_supplier_invoicing.ORDER_CODE = dim_requisitions.ORDER_CODE\n        and sri_supplier_invoicing.ORDER_SUPPLIER = dim_requisitions.ORDER_SUPPLIER\n        and sri_supplier_invoicing.w_business_dt='${business_date}'\n        \nleft outer join epsdlsrid.sri_order_details sri_order_details\n        on sri_order_details.order_code = dim_requisitions.order_code\n        and sri_order_details.w_business_dt='${business_date}'\n\nwhere sri_supply_items.w_business_dt='${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'TANKPAC'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_supplier_invoicing"
  merge_columns:
  - "document_code"
  - "item_serial_no"
  - "invoice_code"
  - "parcial"
  - "order_price"
  - "order_qty"
  - "order_rate"
  - "order_discount"
  - "invoice_price"
  - "invoice_qty"
  - "invoice_rate"
  - "invoice_discount"
  - "item_short_desc"
  - "order_currency"
  - "invoice_amount"
  - "addn_packing_cost"
  - "addn_forwarding_cost"
  - "supplier_invoice_discount"
  - "status"
  - "currency"
  - "invoice_no"
  - "invoice_date"
  - "order_code"
  - "vessel_code"
  - "department"
  - "document_no"
  - "line_type"
  - "order_supplier"
  - "document_date"
  - "comments"
  - "requisition_code"
  - "delivery_date"
  - "delivery_port"
  - "po_description"
  - "department_id"
  - "vessel_id"
  - "supplier_id"
  - "requisition_id"
  endpoint: "lo_delta_tables"

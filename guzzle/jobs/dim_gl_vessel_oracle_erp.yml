version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select master.addl_attribute1\n      ,master.addl_attribute2\n      ,master.addl_attribute3\n      ,master.built\n      ,master.company_structure_in_danaos\n      ,erp.start_date_active as date_built\n      ,master.dwt as dwt\n      ,master.eps_ownership\n      ,master.eps_uk_ownership\n      ,hierarchy.fleet_type\n      ,hierarchy.fleet_type_code\n      ,NULL as fleet_type_sort\n      ,hierarchy.fleet_type_sub_code\n      ,hierarchy.fleet_type_sub\n      ,hierarchy.fleet_code_ fleet_code \n      ,hierarchy.fleet\n      ,master.owning_entity\n      ,erp.dependent_segment_code as owning_entity_codes\n      ,master.ownership\n      ,master.vessel_type\n      ,master.vessel_group\n      ,year(erp.start_date_active) as built_year\n      ,master.vessel_class\n      ,erp.end_date_active as journal_end_date\n      ,erp.start_date_active as journal_start_date\n      ,erp.last_updated_by as last_updated_by\n      ,erp.last_updated_date as last_updated_date\n      ,master.lwt\n      ,master.managed_by_eps\n      ,master.ownership_type\n      ,master.period\n      ,master.qct_ownership\n      ,master.qct_start_date\n      ,master.qps_ownership\n      ,master.sold_date\n      ,master.start_date \n      ,master.useful_life\n      ,hierarchy.vessel_code\n      ,hierarchy.vessel_name\n      ,master.vessel_ownership\n      ,master.region\n\t  ,coalesce(hierarchy.vessel_code,'')||'~'||'ORACLE' as integration_key\n      ,sha2(hierarchy.vessel_code||'ORACLE', 512) as vessel_id\n      ,coalesce(master.include_in_drc,1) as include_in_drc\n\t\t,coalesce(master.supplier_flag,1) as supplier_flag\n\t\t,coalesce(master.port_calls_flag_,1) as port_calls_flag\n      ,null as w_x_custom\n      ,erp.w_job_instance_id\n      ,erp.w_refresh_ts\n      ,null as w_curr_rec_flg\n      ,'ORACLE' as w_data_src_id\n      ,erp.w_location\n      ,erp.w_batch_id\n      ,'${business_date}' as business_date\nfrom ${p_epsdl_sri_db}.sri_vessel_hierarchy hierarchy\nleft join ${p_epsdl_sri_db}.sri_vessel_master master \non master.vessel_code=hierarchy.vessel_code \nand master.w_business_dt='${business_date}'\nleft join (select * from ${p_epsdl_sri_db}.sri_oracle_gl_segment where segment_lov_id='59002') erp\non erp.segment_code=hierarchy.vessel_code \nand erp.w_business_dt='${business_date}'\n\nwhere hierarchy.w_business_dt='${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  incremental: false
target:
  primary_key_columns:
  - "w_data_src_id"
  - "vessel_code"
  operation: "merge"
  soft_delete: false
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_gl_vessel"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  merge_columns:
  - "vessel_name"
  - "fleet_type_sub_code"
  - "fleet_type_sub"
  - "fleet_type_code"
  - "fleet_type"
  - "fleet_code"
  - "fleet"
  - "owning_entity"
  - "owning_entity_codes"
  - "ownership"
  - "vessel_type"
  - "vessel_group"
  - "dwt"
  - "built_year"
  - "sold_date"
  - "vessel_class"
  - "period"
  - "company_structure_in_danaos"
  - "qps_ownership"
  - "qct_ownership"
  - "managed_by_eps"
  - "ownership_type"
  - "built"
  - "date_built"
  - "useful_life"
  - "lwt"
  - "start_date"
  - "journal_start_date"
  - "journal_end_date"
  - "qct_start_date"
  - "addl_attribute1"
  - "addl_attribute2"
  - "addl_attribute3"
  - "last_updated_date"
  - "last_updated_by"
  - "eps_ownership"
  - "eps_uk_ownership"
  - "fleet_type_sort"
  - "vessel_ownership"
  - "region"
  - "vessel_id"
  - "include_in_drc"
  - "supplier_flag"
  - "port_calls_flag"
  endpoint: "lo_delta_tables"

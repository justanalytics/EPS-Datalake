version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with \nMV_SUPPLY_ITEMS_OPEX_MONITOR as\n(\nselect distinct a.DEPARTMENT, B.ITEM_SYSTEM_CODE, B.ITEM_SUBSYSTEM_CODE,coalesce(C.LEDGER_CARD, D.LEDGER_CARD, E.LEDGER_CARD,F.LEDGER_CARD,G.LEDGER_CARD,H.LEDGER_CARD) as LEDGER_CARD,a.ORDER_CODE,a.ORDER_SUPPLIER,a.ORDER_DATE,a.DOCUMENT_DATE,a.DOCUMENT_CODE,a.LINE_TYPE,a.DISPUTED_DATE,a.DISPUTED_COMMENTS,a.APPROVER,B.PARCIAL,B.INVOICE_QTY,B.ORDER_QTY,B.ORDER_DISCOUNT,B.ORDER_RATE,B.ORDER_PRICE,B.REQUESTED_QTY,B.APPROVED_QTY,\nB.ORDER_CURRENCY,B.ITEM_SERIAL_NO,B.ITEM_REF_CODE,a.vessel_code,b.invoice_price,b.INVOICE_RATE,b.INVOICE_DISCOUNT,a.comments\nFROM ${p_epsdl_sri_db}.sri_requisitions A\ninner join ${p_epsdl_sri_db}.sri_supply_items B \non \na.ORDER_CODE = B.ORDER_CODE and a.ORDER_SUPPLIER = B.ORDER_SUPPLIER and  b.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers C on C.DEPARTMENT = a.DEPARTMENT and C.CATALOGUE = B.ITEM_SYSTEM_CODE and C.CATALOGUE_GROUP = B.ITEM_SUBSYSTEM_CODE and c.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers D on D.DEPARTMENT = a.DEPARTMENT and D.CATALOGUE = B.ITEM_SYSTEM_CODE and D.CATALOGUE_GROUP = 'ALL' and d.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers E on E.DEPARTMENT = a.DEPARTMENT and E.CATALOGUE = 'ALL' and E.CATALOGUE_GROUP ='ALL' and e.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers F on F.DEPARTMENT = a.DEPARTMENT and F.CATALOGUE = 'ALL' and f.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers G on G.DEPARTMENT = A.DEPARTMENT AND G.CATALOGUE = '*' AND G.CATALOGUE_GROUP = 'ALL' and g.w_business_dt = '${business_date}'\nleft join ${p_epsdl_sri_db}.sri_item_ledgers H on H.DEPARTMENT = a.DEPARTMENT and H.CATALOGUE = '*' and H.CATALOGUE_GROUP = '*' and h.w_business_dt = '${business_date}'\nwhere a.w_business_dt = '${business_date}'\n),\nMV_VESSELMASTER_DAILY as \n(\nselect\nvessel.vessel_code,\nvessel.vessel_name,\nvessel.w_batch_id,\nvessel.start_date,\nvessel.sold_date,\nperiod.date as full_date,\nvessel.vessel_id\nfrom\n${p_epsdl_db}.dim_gl_vessel vessel\njoin\n${p_epsdl_db}.dim_period period\non period.date between nvl(vessel.JOURNAL_START_DATE,period.date) and nvl(vessel.JOURNAL_END_DATE,period.date)\n)\n\nselect\nSUPPLY_ITEMS.PARCIAL,\nSUPPLY_ITEMS.ORDER_QTY,\nSUPPLY_ITEMS.INVOICE_QTY,\nSUPPLY_ITEMS.ORDER_PRICE,\nSUPPLY_ITEMS.ORDER_RATE,\nSUPPLY_ITEMS.ORDER_DISCOUNT,\nSUPPLY_ITEMS.INVOICE_PRICE,\nSUPPLY_ITEMS.INVOICE_RATE,\nSUPPLY_ITEMS.INVOICE_DISCOUNT,\nDEPT_MAPPING.ACC_CODE,\nDEPT_MAPPING.ACRL_CODE,\nSUPPLY_ITEMS.COMMENTS,\nSUPPLY_ITEMS.DOCUMENT_DATE,\nSUPPLY_ITEMS.ORDER_CURRENCY,\nSUPPLY_ITEMS.ORDER_CODE,\nVESSEL_TEAM_MAP.ACCOUNTS_TEAM,\nVESSEL_TEAM_MAP.BUSINESS_TEAM,\nMV_VESSELMASTER_DAILY.VESSEL_CODE,\ncoalesce(MV_VESSELMASTER_DAILY.vessel_id,'0000') as vessel_id,\nMV_VESSELMASTER_DAILY.VESSEL_NAME,\nSUPPLY_ITEMS.DEPARTMENT,\nSUPPLY_ITEMS.ITEM_SYSTEM_CODE,\nSUPPLY_ITEMS.ITEM_SUBSYSTEM_CODE,\nSUPPLY_ITEMS.LEDGER_CARD,\nSUPPLY_ITEMS.ORDER_SUPPLIER,\nSUPPLY_ITEMS.ORDER_DATE,\nSUPPLY_ITEMS.DISPUTED_DATE,\nSUPPLY_ITEMS.DISPUTED_COMMENTS,\nSUPPLY_ITEMS.APPROVER,\nSUPPLY_ITEMS.REQUESTED_QTY,\nSUPPLY_ITEMS.APPROVED_QTY,\nSUPPLY_ITEMS.ITEM_SERIAL_NO,\nSUPPLY_ITEMS.ITEM_REF_CODE,\ndate(ORDER_DETAILS.DELIVERY_DATE) as DELIVERY_DATE,\n(case  when MV_VESSELMASTER_DAILY.W_BATCH_ID is null then '1-' else '0-' end)||MV_VESSELMASTER_DAILY.VESSEL_CODE as VESSEL_CODE1,\n(case  when MV_VESSELMASTER_DAILY.W_BATCH_ID is null then '1-' else '0-' end)||MV_VESSELMASTER_DAILY.VESSEL_NAME as VESSEL_NAME1,\ncase  when upper(SUPPLY_ITEMS.COMMENTS) like '%DRY DOCK%' or upper(SUPPLY_ITEMS.COMMENTS) like '%DRY%' or upper(SUPPLY_ITEMS.COMMENTS) like '% DD%' or upper(SUPPLY_ITEMS.COMMENTS) like '% DD/%' or upper(SUPPLY_ITEMS.COMMENTS) like '%[DD]%' or upper(SUPPLY_ITEMS.COMMENTS) like 'DD%' or upper(SUPPLY_ITEMS.COMMENTS) like '%TAKE OVER%' or upper(SUPPLY_ITEMS.COMMENTS) like '%UWILD%' or upper(SUPPLY_ITEMS.COMMENTS) like '%UWLD%' or upper(SUPPLY_ITEMS.COMMENTS) like '%TAKEOVER%' or upper(SUPPLY_ITEMS.COMMENTS) like '%CAPITAL%' or upper(SUPPLY_ITEMS.COMMENTS) like '%VOY%' or upper(SUPPLY_ITEMS.COMMENTS) like '%VOYAGE%' or upper(SUPPLY_ITEMS.COMMENTS) like '%VOYAGE COST%' or SUPPLY_ITEMS.DEPARTMENT in ('DDC', 'DDR', 'DDT', 'DP', 'DRY', 'DSP', 'FDD') then 'Y' else 'N' end  as DD_PO_FLAG,\ncase  when upper(SUPPLY_ITEMS.COMMENTS) like '%DRY DOCK%' or upper(SUPPLY_ITEMS.COMMENTS) like '%DRY%' or upper(SUPPLY_ITEMS.COMMENTS) like '% DD%' or upper(SUPPLY_ITEMS.COMMENTS) like '% DD/%' or upper(SUPPLY_ITEMS.COMMENTS) like '%[DD]%' or upper(SUPPLY_ITEMS.COMMENTS) like 'DD%' or upper(SUPPLY_ITEMS.COMMENTS) like '%TAKE OVER%' or upper(SUPPLY_ITEMS.COMMENTS) like '%UWILD%' or upper(SUPPLY_ITEMS.COMMENTS) like '%UWLD%' or upper(SUPPLY_ITEMS.COMMENTS) like '%TAKEOVER%' or upper(SUPPLY_ITEMS.COMMENTS) like '%CAPITAL%' or upper(SUPPLY_ITEMS.COMMENTS) like '%VOY%' or upper(SUPPLY_ITEMS.COMMENTS) like '%VOYAGE%' or upper(SUPPLY_ITEMS.COMMENTS) like '%VOYAGE COST%' or upper(SUPPLY_ITEMS.COMMENTS) like '%CAPEX%' or upper(SUPPLY_ITEMS.COMMENTS) like '%SCRUBBER%' or upper(SUPPLY_ITEMS.COMMENTS) like '%BWTS%' or upper(SUPPLY_ITEMS.COMMENTS) like '%TAKEOVER%' or upper(SUPPLY_ITEMS.COMMENTS) like '%NEW%' or upper(SUPPLY_ITEMS.COMMENTS) like '%PROJECT%' or SUPPLY_ITEMS.DEPARTMENT in ('DD', 'DDC', 'DDP', 'DDR', 'DDS', 'DDT', 'DP', 'DRY', 'DSP', 'FDD') then 'Y' else 'N' end \nAs DD_PO_FLAG_CY,\ncase  when SUPPLY_ITEMS.APPROVER is null then 'N' else 'Y' end as APPROVER_PO_FLAG,\ncoalesce(COA_OPEX_MONITOR.account_id,'000000') as account_id,\ncase  when (SUPPLY_ITEMS.INVOICE_PRICE in (0) or SUPPLY_ITEMS.INVOICE_PRICE is null) and SUPPLY_ITEMS.LINE_TYPE in ('O', 'SO') then case  when SUPPLY_ITEMS.PARCIAL = 1 then SUPPLY_ITEMS.ORDER_PRICE * SUPPLY_ITEMS.ORDER_QTY * SUPPLY_ITEMS.ORDER_RATE - SUPPLY_ITEMS.ORDER_PRICE * SUPPLY_ITEMS.ORDER_QTY * SUPPLY_ITEMS.ORDER_DISCOUNT / 100 * SUPPLY_ITEMS.ORDER_RATE end  end as item_amount_po_usd,\nSUPPLY_ITEMS.DOCUMENT_CODE,\nSUPPLY_ITEMS.LINE_TYPE,\nCASE WHEN MV_VESSELMASTER_DAILY.START_DATE <= to_date(string(year(current_date())||'-12-31'))\nand (MV_VESSELMASTER_DAILY.SOLD_DATE >= to_date(date_trunc('YEAR', current_date())) or MV_VESSELMASTER_DAILY.SOLD_DATE is null) THEN 'Y' else 'N' end as Vessel_Current_year_Flag,\nSUPPLY_ITEMS.ORDER_CODE||'-'||SUPPLY_ITEMS.LINE_TYPE as order_code_line_type\nfrom\nMV_SUPPLY_ITEMS_OPEX_MONITOR SUPPLY_ITEMS\nleft join\n${p_epsdl_sri_db}.sri_del_departments DEL_DEPARTMENTS\non\nSUPPLY_ITEMS.DEPARTMENT = DEL_DEPARTMENTS.CODE\nand \nDEL_DEPARTMENTS.w_business_dt = '${business_date}'\nleft join\nMV_VESSELMASTER_DAILY MV_VESSELMASTER_DAILY\non\nMV_VESSELMASTER_DAILY.VESSEL_CODE = SUPPLY_ITEMS.VESSEL_CODE\nand MV_VESSELMASTER_DAILY.FULL_DATE = date(SUPPLY_ITEMS.DOCUMENT_DATE)\n\nleft join \n${p_epsdl_sri_db}.sri_order_details ORDER_DETAILS \nOn ORDER_DETAILS.ORDER_CODE = SUPPLY_ITEMS.ORDER_CODE\nand \nORDER_DETAILS.w_business_dt = '${business_date}'\nleft join\n${p_epsdl_sri_db}.sri_dept_mapping DEPT_MAPPING\non\nDEL_DEPARTMENTS.CODE = DEPT_MAPPING.DEPT_CODE\nand \nDEPT_MAPPING.w_business_dt = '${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_vessel_team_map VESSEL_TEAM_MAP\non\nMV_VESSELMASTER_DAILY.VESSEL_CODE = VESSEL_TEAM_MAP.COMPANY and VESSEL_TEAM_MAP.w_business_dt = '${business_date}'\nleft join\n${p_epsdl_db}.dim_gl_account COA_OPEX_MONITOR\non\nCOA_OPEX_MONITOR.LEDGER_CARD = SUPPLY_ITEMS.LEDGER_CARD\nand\nCOA_OPEX_MONITOR.SOURCE_SYSTEM='DANAOS'\n"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_os_po"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with delivery_point AS\n(\n    select * FROM epsdlsrid.sri_delivery_point where w_business_dt = '${business_date}'\n)\n, order_details AS\n(\n    select * FROM epsdlsrid.sri_order_details where w_business_dt = '${business_date}'\n)\n, supply_items AS\n(\n    select * FROM epsdlsrid.sri_supply_items where w_business_dt = '${business_date}'\n)\n, requisition AS\n(\n    select * FROM epsdlsrid.sri_requisitions where w_business_dt = '${business_date}'\n)\n, base AS\n(\n   SELECT \n    this_.DOCUMENT_CODE \n    ,this_.document_date as period \n    ,dldpt1_.NAME AS DEPT_NAME \n    ,this_.REQUISITION_CODE  \n    ,this_.DEPARTMENT \n    ,this_.VESSEL_CODE \n    ,this_.ORDER_CODE \n    ,A.SUPPLIER_NAME AS RFQ_SUPPLIER_NAME \n    ,vslinfo2_.VESSEL_NAME \n\n    ,this_.LINE_TYPE\n    ,this_.DISPUTED_FLAG\n    ,this_.APPROVER\n\n    ,dldpt1_.DEPT_REFERENCE\n    ,podtl3_.DELIVERY_POINT_ID\n    ,delpoint4_.STATUS\n    ,this_.w_data_src_id\n    ,this_.business_date\n    ,this_.w_refresh_ts\n    ,this_.w_job_instance_id\n    ,this_.w_location\n    ,this_.w_batch_id\n    ,null as w_x_custom\n    ,null as w_curr_rec_flg\n\nFROM requisition this_ \nINNER JOIN epsdlsrid.sri_vessel_hierarchy vslinfo2_ ON this_.VESSEL_CODE=vslinfo2_.VESSEL_CODE \n                                                    and vslinfo2_.w_business_dt = '${business_date}'\nINNER JOIN epsdlsrid.sri_del_departments dldpt1_ ON this_.DEPARTMENT=dldpt1_.CODE \n                                                and dldpt1_.w_business_dt = '${business_date}'\nLEFT OUTER JOIN epsdlsrid.sri_order_details podtl3_ ON this_.ORDER_CODE=podtl3_.ORDER_CODE \n                                                   and podtl3_.w_business_dt = '${business_date}'\nleft outer join epsdlsrid.sri_delivery_point delpoint4_ on podtl3_.DELIVERY_POINT_ID=delpoint4_.ID \nleft join epsdlsrid.sri_supplier_registry A on A.SUPPLIER_CODE = (CASE WHEN this_.LINE_TYPE = 'Q' THEN this_.QUOTATION_SUPPLIER ELSE this_.ORDER_SUPPLIER END)\n                                           and podtl3_.w_business_dt = '${business_date}'\n)\n\nSELECT distinct\n    5001 as REQ_ID\n   ,'ALL ACTIVE REQUISITIONS' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n   ,'5001'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nleft join requisition this_0_ on this_0_.DOCUMENT_CODE = this_.DOCUMENT_CODE\n                                          and this_.LINE_TYPE = 'R' \n                                          AND this_0_.LINE_TYPE IN ('O', 'SO', 'D', 'I')\nleft join requisition this_1_ on this_1_.ORDER_CODE = this_.ORDER_CODE\n                                          and this_.LINE_TYPE in ('O', 'SO', 'DP') \nWHERE \n    this_.LINE_TYPE in ('R', 'O', 'SO', 'DP') \n    and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y') \n    and this_.DEPT_REFERENCE is not null\n    and\n    ( this_0_.DOCUMENT_CODE is null\n    or this_1_.ORDER_CODE is not null\n    )\n    AND \n    not exists (SELECT this_0_.ID as y0_ \n                FROM delivery_point this_0_ \n                WHERE this_.ORDER_CODE is not null \n                and this_.DELIVERY_POINT_ID is not null \n\t            and this_.DELIVERY_POINT_ID = this_0_.ID \n                and this_0_.STATUS = 'DELIVERED')\n\nunion all\n\nSELECT distinct\n    5002 as REQ_ID\n   ,'CANCELLED REQUISITIONS' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n   ,'5002'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE \nthis_.LINE_TYPE in ('R', 'SO', 'DP') and this_.DISPUTED_FLAG = 'Y'\n\nunion all\n\nSELECT distinct\n    5003 as REQ_ID\n   ,'PENDING FOR RFQ' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5003'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE \nthis_.LINE_TYPE = 'R' and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y')\nand \n(\n\tnot exists (SELECT this_0_.DOCUMENT_CODE \n                FROM requisition this_0_ \n                WHERE this_0_.DOCUMENT_CODE = this_.DOCUMENT_CODE \n                and this_0_.LINE_TYPE in ('Q', 'O', 'SO', 'D', 'I'))\n)\n\nunion all\n\nSELECT distinct\n    5004 as REQ_ID\n   ,'PENDING FOR EVALUATION' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5004'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE \nthis_.LINE_TYPE = 'R' and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y')\nand \n(\n\tEXISTS (SELECT this_0_.DOCUMENT_CODE \n            FROM requisition this_0_ \n            WHERE this_0_.DOCUMENT_CODE = this_.DOCUMENT_CODE \n            AND this_0_.LINE_TYPE = 'Q' \n            AND this_0_.APPROVER IS NULL)\n\tand not exists (SELECT this_0_.DOCUMENT_CODE \n                    FROM requisition this_0_ \n                    WHERE this_0_.DOCUMENT_CODE = this_.DOCUMENT_CODE \n                    and this_0_.LINE_TYPE in ( 'O', 'SO', 'D', 'I'))\n)\n\nunion all\n\nSELECT distinct\n    5005 as REQ_ID\n   ,'PENDING FOR PO' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5005'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE = 'R' and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y')\nand \n(\n\tEXISTS (SELECT this_0_.DOCUMENT_CODE \n            FROM requisition this_0_ \n            WHERE this_0_.DOCUMENT_CODE = this_.DOCUMENT_CODE \n            AND this_0_.LINE_TYPE = 'Q' \n            AND this_0_.APPROVER IS NOT NULL)\n\tand not exists (SELECT this_0_.DOCUMENT_CODE \n                    FROM requisition this_0_ \n                    WHERE this_0_.DOCUMENT_CODE = this_.DOCUMENT_CODE \n                    and this_0_.LINE_TYPE in ( 'O', 'SO', 'D', 'I'))\n)\n\nunion all\n\nSELECT distinct\n    5006 as REQ_ID\n   ,'POs PENDING FOR APPROVAL' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5006'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE IN ('O','SO') AND (this_.DISPUTED_FLAG IS NULL OR this_.DISPUTED_FLAG <> 'Y') AND this_.APPROVER IS NULL\n\nunion all\n\nSELECT distinct\n    5007 as REQ_ID\n   ,'POs PENDING DELIVERY PLAN' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5007'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE IN ('O','SO','DP') and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y') \nand exists (SELECT ORDER_CODE \n            FROM order_details\n            WHERE ORDER_CODE = this_.ORDER_CODE \n            AND DELIVERY_POINT_ID IS NULL)\n\nunion all\n\nSELECT distinct\n    5008 as REQ_ID\n   ,'POs PENDING DELIVERY' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5008'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE IN ('O','SO','DP') and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y') \nand this_.STATUS <> 'DELIVERED'\n\nunion all\n\nSELECT distinct\n    5009 as REQ_ID\n   ,'POs DELIVERD' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5009'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE IN ('O','SO','DP') and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y') \nand this_.STATUS = 'DELIVERED'\n\nunion all\n\nSELECT distinct\n    5010 as REQ_ID\n   ,'POs PENDING FOR DO' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5010'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE IN ('O','SO') and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y') and this_.APPROVER IS NOT NULL\nand EXISTS (SELECT tx.DOCUMENT_CODE \n            FROM supply_items tx \n            WHERE tx.DOCUMENT_CODE = this_.DOCUMENT_CODE \n            AND tx.Order_Code IS NOT NULL \n            AND tx.Order_Code <> '#' \n            AND tx.Deliverd_Status = 0)\n\nunion all\n\nSELECT distinct\n    5011 as REQ_ID\n   ,'POs PENDING FOR INVOICE' as REQ_DESC\n   ,this_.DOCUMENT_CODE, this_.period, this_.DEPT_NAME, this_.REQUISITION_CODE, this_.DEPARTMENT, this_.VESSEL_CODE, this_.ORDER_CODE, this_.RFQ_SUPPLIER_NAME, this_.VESSEL_NAME\n    ,'5011'||'~'||coalesce(this_.DOCUMENT_CODE,'')||'~'||coalesce(this_.ORDER_CODE,'')||'~'||coalesce(this_.RFQ_SUPPLIER_NAME,'') as integration_key\n   ,this_.w_data_src_id,this_.business_date,this_.w_refresh_ts,this_.w_job_instance_id,this_.w_location,this_.w_batch_id,null as w_x_custom,null as w_curr_rec_flg\n\nFROM base this_\nWHERE\nthis_.LINE_TYPE IN ('O','SO') and (this_.DISPUTED_FLAG is null or this_.DISPUTED_FLAG <> 'Y') and this_.APPROVER IS NOT NULL\nAND EXISTS (SELECT tx.DOCUMENT_CODE \n            FROM supply_items TX \n            WHERE TX.DOCUMENT_CODE = this_.DOCUMENT_CODE \n            AND TX.Order_Code IS NOT NULL \n            AND TX.Order_Code <> '#' \n            AND TX.Invoice_Status = 0)\n"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'TANKPAC'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_requisitions_category"
  merge_columns:
  - "req_id"
  - "req_desc"
  - "document_code"
  - "period"
  - "dept_name"
  - "requisition_code"
  - "department"
  - "vessel_code"
  - "order_code"
  - "rfq_supplier_name"
  - "vessel_name"
  endpoint: "lo_delta_tables"

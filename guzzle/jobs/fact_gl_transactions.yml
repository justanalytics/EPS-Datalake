version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select\naccount_id,\naccrual_flag,\naccrual_type,\naccrued_by_user,\naccrued_by_user_2,\naccrued_on_date,\nallocation_date_from,\nallocation_date_to,\namount,\napplication_code,\napplication_ref,\napproval_level,\napproved_by,\nar_type,\nbank,\nbook_credit_off,\nbook_debit_off,\nbook_value,\nbook_value_off,\nbook_value2,\nbook_value3,\nbudget,\nbunker_price,\nbunker_qty,\nbusiness_date,\ncode_combination_id,\ncompany_id,\ncreated_by_user,\ncreated_by_user_2,\ncurrency,\ncurrency3,\ndb_userid,\ndebit_credit,\ndelete_flag,\ndepartment_id,\ndocument_category,\ndocument_code,\ndocument_date,\ndocument_status,\ndocument_subject,\ndocument_subsubject,\ndocument_type,\ndue_date,\nentry_number,\nentry_rate,\nentry_rate2,\nentry_rate3,\nfiled_to,\nfiled_to3,\nfinalized_by_user,\nfinalized_by_user_2,\nflag1,\nflag2,\nflag3,\nflag4,\nfrom_to,\nfuture1_id,\nfuture2_id,\nfx_rate,\nimport_status,\nimported_by,\ninc_exp_category,\ninc_exp_group,\ninstrument_no,\nintegration_key,\nintercompany_id,\ninternal_ref,\nissue_date,\njob_number,\njournal_company,\njournal_date,\njournal_id,\njournal_line,\njournal_narrative,\njournal_number,\njournal_posting,\njournal_reference,\njournal_series,\njournal_status,\njournal_user,\njournal_user_2,\nlast_updated,\nledger_id,\nmatching_company,\nmatching_line,\nmatching_number,\nmatching_series,\nmc_reference,\nname,\nopen_item_status,\noperation_code1,\noperation_code2,\noperation_id1,\noperation_id2,\noperation_subid_1,\noperation_subid_2,\norder_code,\norder_number,\nour_company,\npay_approval_level,\npay_flag,\npay_selected,\npayment_method,\nplace,\nprt_flag,\nremarks,\nreporting_amount,\nrow_num,\nserial_no,\nservice_id,\nset_currency_amount,\nspot_rate_flag,\nsubmission_date,\nsup_match,\nsupplier_code,\nteam,\ncoalesce(tot_book_credit, 0) tot_book_credit,\ntot_book_credit2,\ntot_book_credit3,\ncoalesce(tot_book_debit, 0) tot_book_debit,\ntot_book_debit2,\ntot_book_debit3,\ntot_global_credit,\ntot_global_debit,\ncoalesce(tot_local_credit, 0) tot_local_credit,\ncoalesce(tot_local_debit, 0) tot_local_debit,\ntransaction_cost,\ntransaction_type,\nvalue_date,\nvat_amount,\nvat_category,\nvat_number,\nvessel_code,\nvessel_id,\nw_batch_id,\nw_curr_rec_flg,\nw_data_src_id,\nw_job_instance_id,\nw_location,\nw_refresh_ts,\nw_x_custom,\nwithholding_tax_amount,\nwithholding_tax_code,\nnull as je_source\nfrom ${p_epsdl_db}.fact_gl_transactions_danaos\n\nunion\n\nselect\naccount_id,\naccrual_flag,\naccrual_type,\naccrued_by_user,\naccrued_by_user_2,\naccrued_on_date,\nallocation_date_from,\nallocation_date_to,\namount,\napplication_code,\napplication_ref,\napproval_level,\napproved_by,\nar_type,\nbank,\nbook_credit_off,\nbook_debit_off,\nbook_value,\nbook_value_off,\nbook_value2,\nbook_value3,\nbudget,\nbunker_price,\nbunker_qty,\nbusiness_date,\ncode_combination_id,\ncompany_id,\ncreated_by_user,\ncreated_by_user_2,\ncurrency,\ncurrency3,\ndb_userid,\ndebit_credit,\ndelete_flag,\ndepartment_id,\ndocument_category,\ndocument_code,\ndocument_date,\ndocument_status,\ndocument_subject,\ndocument_subsubject,\ndocument_type,\ndue_date,\nentry_number,\nentry_rate,\nentry_rate2,\nentry_rate3,\nfiled_to,\nfiled_to3,\nfinalized_by_user,\nfinalized_by_user_2,\nflag1,\nflag2,\nflag3,\nflag4,\nfrom_to,\nfuture1_id,\nfuture2_id,\nfx_rate,\nimport_status,\nimported_by,\ninc_exp_category,\ninc_exp_group,\ninstrument_no,\nintegration_key,\nintercompany_id,\ninternal_ref,\nissue_date,\njob_number,\njournal_company,\njournal_date,\njournal_id,\njournal_line,\njournal_narrative,\njournal_number,\njournal_posting,\njournal_reference,\njournal_series,\njournal_status,\njournal_user,\njournal_user_2,\nlast_updated,\nledger_id,\nmatching_company,\nmatching_line,\nmatching_number,\nmatching_series,\nmc_reference,\nname,\nopen_item_status,\noperation_code1,\noperation_code2,\noperation_id1,\noperation_id2,\noperation_subid_1,\noperation_subid_2,\norder_code,\norder_number,\nour_company,\npay_approval_level,\npay_flag,\npay_selected,\npayment_method,\nplace,\nprt_flag,\nremarks,\nreporting_amount,\nrow_num,\nserial_no,\nservice_id,\nset_currency_amount,\nspot_rate_flag,\nsubmission_date,\nsup_match,\nsupplier_code,\nteam,\ncoalesce(tot_book_credit, 0) tot_book_credit,\ntot_book_credit2,\ntot_book_credit3,\ncoalesce(tot_book_debit, 0) tot_book_debit,\ntot_book_debit2,\ntot_book_debit3,\ntot_global_credit,\ntot_global_debit,\ncoalesce(tot_local_credit, 0) tot_local_credit,\ncoalesce(tot_local_debit, 0) tot_local_debit,\ntransaction_cost,\ntransaction_type,\nvalue_date,\nvat_amount,\nvat_category,\nvat_number,\nvessel_code,\nvessel_id,\nw_batch_id,\nw_curr_rec_flg,\nw_data_src_id,\nw_job_instance_id,\nw_location,\nw_refresh_ts,\nw_x_custom,\nwithholding_tax_amount,\nwithholding_tax_code,\nje_source\nfrom ${p_epsdl_db}.fact_gl_transactions_oracle_erp"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
  incremental: false
target:
  operation: "overwrite"
  soft_delete: false
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_gl_transactions"
    post_sql:
    - "merge into ${p_epsdl_db}.fact_gl_transactions as tgt using ( select distinct yesterday.journal_company,yesterday.journal_Series,yesterday.journal_number,yesterday.journal_line,yesterday.w_source_system,yesterday.journal_date from (select * from ${p_epsdl_sri_db}.sri_documents where date(w_business_dt)=date_sub(current_date(),1) and year(journal_date) in (year(current_date),(year(current_date)-1))) yesterday left join (select * from ${p_epsdl_sri_db}.sri_documents where date(w_business_dt)=current_date()) today on today.journal_company=yesterday.journal_company and today.journal_Series=yesterday.journal_Series and today.journal_number=yesterday.journal_number and today.journal_line=yesterday.journal_line and  today.w_source_system=yesterday.w_source_system where today.journal_company is null ) as src on (src.journal_company=tgt.journal_company and src.journal_Series=tgt.journal_Series and src.journal_number=tgt.journal_number and src.journal_line=tgt.journal_line and  src.w_source_system=tgt.w_data_src_id and year(tgt.journal_date) in (year(current_date),(year(current_date)-1)) ) when matched then update set tgt.delete_flag=1"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  endpoint: "lo_delta_tables"

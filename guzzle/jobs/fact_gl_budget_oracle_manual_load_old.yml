version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select\n\t\tperiod.date_id\n        ,coalesce(dim_gl_company.company_id,'0000') as company_id\n\t\t,coalesce(dim_gl_vessel .vessel_id, '0000') AS vessel_id\n\t\t,coalesce(dim_gl_service.service_id, '00') AS service_id\n\t\t,coalesce(dim_gl_department.department_id, '000') AS department_id\n\t\t,coalesce(account.account_id, '000000') AS account_id\n\t\t,coalesce(dim_gl_intercompany.intercompany_id, '0000') AS intercompany_id\n\t\t,coalesce(future1.future1_id, '000') AS future1_id\n\t\t,coalesce(future2.future2_id, '0000') AS future2_id\n\n\t\t,coalesce(dim_gl_company.child_value, '') || '~' || coalesce(dim_gl_vessel.vessel_code, '') || '~' || coalesce(dim_gl_service.service_code, '') || '~' || coalesce(account.oracle_natural_account, '') || '~' || coalesce(dim_gl_intercompany.intercompany_code, '') || '~' || coalesce(dim_gl_department.child_value, '') || '~' || coalesce(future1.future1_code, '') || '~' || coalesce(future2.future2_code, '') as code_combination_id\n\t\t\n\t\t,null as BUDGET_VERSION_ID\n\t\t,'B' as ACTUAL_FLAG\n\t\t, cast(sri_balance.Amt as decimal(38,18)) / tmp_ship_days.SHIPDAYS as DAILY_PERIOD_NET_DR\n\t\t,0 / tmp_ship_days.SHIPDAYS as DAILY_PERIOD_NET_CR\n\t\t,0 / tmp_ship_days.SHIPDAYS as DAILY_DEBIT_BALANCE\n\t\t,0 / tmp_ship_days.SHIPDAYS as DAILY_CREDIT_BALANCE\n\n\t\t,tmp_ship_days.SHIPDAYS\n\t\t,cast(sri_balance.Amt as decimal(38,18)) as PERIOD_NET_DR\n\t\t,0 as PERIOD_NET_CR\n\t\t,0 as DEBIT_BALANCE\n\t\t,0 as CREDIT_BALANCE\n\t\t,null as integration_key\n\t\t,'300000002259034' as ledger_id\n\t\t,account.ledger_card\n\t\t\nFROM ${p_epsdl_sri_db}.sri_oracle_fact_gl_balance_manual_load sri_balance\n\nLEFT JOIN ( /* company  */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_company WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_company ON dim_gl_company.child_value = sri_balance.Entity\n\tAND dim_gl_company.w_data_src_id = 'ORACLE'\n\nLEFT JOIN ( /* vessel  */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_vessel WHERE w_data_src_id = 'MANUAL'\n\t) dim_gl_vessel ON dim_gl_vessel.vessel_code = sri_balance.Vessel\n\nLEFT JOIN ( /* service */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_service WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_service ON dim_gl_service.service_code = sri_balance.Service\n\tAND dim_gl_service.w_data_src_id = 'ORACLE'\n\tAND dim_gl_service.integration_key != '00'\n\nLEFT JOIN (/* department */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_department WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_department ON dim_gl_department.child_value = sri_balance.Department\n\tAND dim_gl_department.w_data_src_id = 'ORACLE'\n\tAND dim_gl_department.integration_key != '000'\n\t\nLEFT JOIN (/* natural account */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_reporting_lines WHERE w_data_src_id = 'ORACLE'\n\t) account ON account.oracle_natural_account = sri_balance.Account\n\tAND account.w_data_src_id = 'ORACLE'\n\nLEFT JOIN (/* intercompany */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_intercompany WHERE w_data_src_id = 'ORACLE'\n\t) AS dim_gl_intercompany ON dim_gl_intercompany.intercompany_code = sri_balance.Intercompany\n\tAND dim_gl_intercompany.w_data_src_id = 'ORACLE'\n\n\t/* future1 */\nLEFT JOIN ${p_epsdl_db}.dim_gl_future1 future1 ON future1.future1_code = sri_balance.Future1\n\tAND future1.w_data_src_id = 'ORACLE'\n\tAND future1.integration_key != '000'\n\n/* future2 */\nLEFT JOIN ${p_epsdl_db}.dim_gl_future2 future2 ON future2.future2_code = sri_balance.Future2\n\tAND future2.w_data_src_id = 'ORACLE'\n\tAND future2.integration_key != '000'\t\n\t\nJOIN ${p_epsdl_sri_db}.tmp_sri_oracle_ship_days_old tmp_ship_days\n    ON tmp_ship_days.vessel_id = dim_gl_vessel.vessel_id\n\tAND tmp_ship_days.period = last_day(to_date(sri_balance.Period, 'yyyy/MM/dd'))\n\t\nJOIN ${p_epsdl_db}.dim_period period \n    ON period.date BETWEEN coalesce(dim_gl_vessel.START_DATE, current_date()) \n              and coalesce(dim_gl_vessel.SOLD_DATE , last_day(current_date()))\n    AND tmp_ship_days.period between date_add(last_day(add_months(period.date, -1)),1) and last_day(period.date)\nwhere sri_balance.period='2021/01/21'\nunion all\nselect\n\t\tperiod.date_id\n        ,coalesce(dim_gl_company.company_id,'0000') as company_id\n\t\t,coalesce(dim_gl_vessel .vessel_id, '0000') AS vessel_id\n\t\t,coalesce(dim_gl_service.service_id, '00') AS service_id\n\t\t,coalesce(dim_gl_department.department_id, '000') AS department_id\n\t\t,coalesce(account.account_id, '000000') AS account_id\n\t\t,coalesce(dim_gl_intercompany.intercompany_id, '0000') AS intercompany_id\n\t\t,coalesce(future1.future1_id, '000') AS future1_id\n\t\t,coalesce(future2.future2_id, '0000') AS future2_id\n\n\t\t,coalesce(dim_gl_company.child_value, '') || '~' || coalesce(dim_gl_vessel.vessel_code, '') || '~' || coalesce(dim_gl_service.service_code, '') || '~' || coalesce(account.oracle_natural_account, '') || '~' || coalesce(dim_gl_intercompany.intercompany_code, '') || '~' || coalesce(dim_gl_department.child_value, '') || '~' || coalesce(future1.future1_code, '') || '~' || coalesce(future2.future2_code, '') as code_combination_id\n\t\t\n\t\t,null as BUDGET_VERSION_ID\n\t\t,'B' as ACTUAL_FLAG\n\t\t, cast(sri_balance.Amt as decimal(38,18)) / tmp_ship_days.SHIPDAYS as DAILY_PERIOD_NET_DR\n\t\t,0 / tmp_ship_days.SHIPDAYS as DAILY_PERIOD_NET_CR\n\t\t,0 / tmp_ship_days.SHIPDAYS as DAILY_DEBIT_BALANCE\n\t\t,0 / tmp_ship_days.SHIPDAYS as DAILY_CREDIT_BALANCE\n\n\t\t,tmp_ship_days.SHIPDAYS\n\t\t,cast(sri_balance.Amt as decimal(38,18)) as PERIOD_NET_DR\n\t\t,0 as PERIOD_NET_CR\n\t\t,0 as DEBIT_BALANCE\n\t\t,0 as CREDIT_BALANCE\n\t\t,null as integration_key\n\t\t,'300000002259034' as ledger_id\n\t\t,account.ledger_card\n\t\t\nFROM ${p_epsdl_sri_db}.sri_oracle_fact_gl_balance_manual_load sri_balance\n\nLEFT JOIN ( /* company  */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_company WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_company ON dim_gl_company.child_value = sri_balance.Entity\n\tAND dim_gl_company.w_data_src_id = 'ORACLE'\n\nLEFT JOIN ( /* vessel  */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_vessel WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_vessel ON dim_gl_vessel.vessel_code = sri_balance.Vessel\n\nLEFT JOIN ( /* service */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_service WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_service ON dim_gl_service.service_code = sri_balance.Service\n\tAND dim_gl_service.w_data_src_id = 'ORACLE'\n\tAND dim_gl_service.integration_key != '00'\n\nLEFT JOIN (/* department */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_department WHERE w_data_src_id = 'ORACLE'\n\t) dim_gl_department ON dim_gl_department.child_value = sri_balance.Department\n\tAND dim_gl_department.w_data_src_id = 'ORACLE'\n\tAND dim_gl_department.integration_key != '000'\n\t\nLEFT JOIN (/* natural account */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_reporting_lines WHERE w_data_src_id = 'ORACLE'\n\t) account ON account.oracle_natural_account = sri_balance.Account\n\tAND account.w_data_src_id = 'ORACLE'\n\nLEFT JOIN (/* intercompany */\n\tSELECT * FROM ${p_epsdl_db}.dim_gl_intercompany WHERE w_data_src_id = 'ORACLE'\n\t) AS dim_gl_intercompany ON dim_gl_intercompany.intercompany_code = sri_balance.Intercompany\n\tAND dim_gl_intercompany.w_data_src_id = 'ORACLE'\n\n\t/* future1 */\nLEFT JOIN ${p_epsdl_db}.dim_gl_future1 future1 ON future1.future1_code = sri_balance.Future1\n\tAND future1.w_data_src_id = 'ORACLE'\n\tAND future1.integration_key != '000'\n\n/* future2 */\nLEFT JOIN ${p_epsdl_db}.dim_gl_future2 future2 ON future2.future2_code = sri_balance.Future2\n\tAND future2.w_data_src_id = 'ORACLE'\n\tAND future2.integration_key != '000'\t\n\t\nJOIN ${p_epsdl_sri_db}.tmp_sri_oracle_ship_days_old tmp_ship_days\n    ON tmp_ship_days.vessel_id = dim_gl_vessel.vessel_id\n\tAND tmp_ship_days.period = last_day(to_date(sri_balance.Period, 'yyyy/MM/dd'))\n\t\nJOIN ${p_epsdl_db}.dim_period period \n    ON period.date BETWEEN coalesce(dim_gl_vessel.START_DATE, current_date()) \n              and coalesce(dim_gl_vessel.SOLD_DATE , to_date('2021-12-31', 'yyyy-MM-dd')  )\n    AND tmp_ship_days.period between date_add(last_day(add_months(period.date, -1)),1) and last_day(period.date)\nwhere sri_balance.period != '2021/01/21'"
  incremental: false
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'ORACLE'"
  - name: "w_data_src_id"
    value: "'ORACLE'"
target:
  operation: "overwrite"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_gl_budget_oracle_old"
    pre_sql:
    - "set spark.sql.autoBroadcastJoinThreshold=-1"
  endpoint: "lo_delta_tables"
  soft_delete: false

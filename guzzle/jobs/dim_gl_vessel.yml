version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select \nsri_vessel_hierarchy.vessel_code\n,sri_vessel_hierarchy.vessel_name\n,sri_vessel_hierarchy.fleet_type_sub_code\n,sri_vessel_hierarchy.fleet_type_sub\n,sri_vessel_hierarchy.fleet_type_code\n,sri_vessel_hierarchy.fleet_type\n,sri_vessel_hierarchy.fleet_code\n,sri_vessel_hierarchy.fleet\n,sri_vessel_master.owning_entity\n,sri_vessel_master.owning_entity_codes\n,sri_vessel_master.ownership\n,sri_vessel_master.vessel_type\n,sri_vessel_master.vessel_group\n,sri_vessel_master.dwt\n,sri_vessel_master.built_year\n,sri_vessel_master.sold_date\n,sri_vessel_master.vessel_class\n,sri_vessel_master.period\n,sri_vessel_master.company_structure_in_danaos\n,sri_vessel_master.qps_ownership\n,sri_vessel_master.qct_ownership\n,sri_vessel_master.managed_by_eps\n,sri_vessel_master.ownership_type\n,sri_vessel_master.built\n,sri_vessel_master.date_built\n,sri_vessel_master.useful_life\n,sri_vessel_master.lwt\n,sri_vessel_master.start_date\n,sri_vessel_master.journal_start_date\n,sri_vessel_master.journal_end_date\n,sri_vessel_master.qct_start_date\n,sri_vessel_master.addl_attribute1\n,sri_vessel_master.addl_attribute2\n,sri_vessel_master.addl_attribute3\n,sri_vessel_master.last_updated_date\n,sri_vessel_master.last_updated_by\n,sri_vessel_master.eps_ownership\n,sri_vessel_master.eps_uk_ownership\n,sri_vessel_master.fleet_type_sort\n,sri_vessel_master.vessel_ownership\n,sri_vessel_master.region\n,coalesce(sri_vessel_master.include_in_drc,1) as include_in_drc\n,coalesce(sri_vessel_master.supplier_flag,1) as supplier_flag\n,coalesce(sri_vessel_master.port_calls_flag,1) as port_calls_flag\n,sri_vessel_hierarchy.integration_key as integration_key \n,sha2(sri_vessel_hierarchy.vessel_code, 512) as vessel_id\n,null as w_x_custom\n,sri_vessel_hierarchy.w_job_instance_id as w_job_instance_id \n,sri_vessel_hierarchy.w_refresh_ts as w_refresh_ts\n,null as w_curr_rec_flg\n,sri_vessel_hierarchy.w_source_system as w_data_src_id\n,sri_vessel_hierarchy.w_location as w_location\n,sri_vessel_hierarchy.w_batch_id as w_batch_id\n,'${business_date}' as business_date\nfrom ${p_epsdl_sri_db}.sri_vessel_hierarchy sri_vessel_hierarchy\nleft join ${p_epsdl_sri_db}.sri_vessel_master sri_vessel_master \non sri_vessel_hierarchy.vessel_code = sri_vessel_master.vessel_code and sri_vessel_master.w_business_dt = '${business_date}'\nwhere sri_vessel_hierarchy.w_business_dt='${business_date}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_gl_vessel"
    post_sql:
    - "delete from ${p_epsdl_db}.dim_gl_vessel where vessel_id is null"
  merge_columns:
  - "vessel_code"
  - "vessel_name"
  - "fleet_type_sub_code"
  - "fleet_type_sub"
  - "fleet_type_code"
  - "fleet_type"
  - "fleet_code"
  - "fleet"
  - "owning_entity"
  - "owning_entity_codes"
  - "ownership"
  - "vessel_type"
  - "vessel_group"
  - "dwt"
  - "built_year"
  - "sold_date"
  - "vessel_class"
  - "period"
  - "company_structure_in_danaos"
  - "qps_ownership"
  - "qct_ownership"
  - "managed_by_eps"
  - "ownership_type"
  - "built"
  - "date_built"
  - "useful_life"
  - "lwt"
  - "start_date"
  - "journal_start_date"
  - "journal_end_date"
  - "qct_start_date"
  - "addl_attribute1"
  - "addl_attribute2"
  - "addl_attribute3"
  - "last_updated_date"
  - "last_updated_by"
  - "eps_ownership"
  - "eps_uk_ownership"
  - "fleet_type_sort"
  - "vessel_ownership"
  - "region"
  - "vessel_id"
  - "include_in_drc"
  - "supplier_flag"
  - "port_calls_flag"
  endpoint: "lo_delta_tables"

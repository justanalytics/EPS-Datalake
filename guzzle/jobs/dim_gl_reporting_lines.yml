version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "select\noracle_natural_account\n,account_group\n,acct_grouping_level4\n,acct_grouping_level3\n,acct_grouping_level2\n,acct_grouping_level1\n,ledger_card\n,danaos_name\n,source_system\n,integration_key\n,account_id\n,w_batch_id\n,business_date\n,w_data_src_id\n,w_refresh_ts\n,w_x_custom\n,w_job_instance_id\n,w_curr_rec_flg\n,w_location\nfrom ${p_epsdl_db}.dim_gl_reporting_lines_danaos\n\nunion all\n\nselect\noracle_natural_account\n,account_group\n,acct_grouping_level4\n,acct_grouping_level3\n,acct_grouping_level2\n,acct_grouping_level1\n,case when ledger_card='000000' then oracle_natural_account else ledger_card end as ledger_card\n,danaos_name\n,source_system\n,integration_key\n,account_id\n,w_batch_id\n,business_date\n,w_data_src_id\n,w_refresh_ts\n,w_x_custom\n,w_job_instance_id\n,w_curr_rec_flg\n,w_location\nfrom ${p_epsdl_db}.dim_gl_reporting_lines_oracle_erp\n"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  incremental: false
target:
  operation: "overwrite"
  soft_delete: false
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_gl_reporting_lines"
    post_sql:
    - "delete from ${p_epsdl_db}.dim_gl_reporting_lines where account_id is null"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
  tags:
  - "epsdl_fact"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with VW_REQUISITIONS as \n(\nselect * from ${p_epsdl_sri_db}.sri_requisitions \nwhere line_type in('O','SO') or line_type is null\n)\n\nselect * from \n(\nselect \nDOCUMENTS.document_date,\nDOCUMENTS.document_type,\nDOCUMENTS.our_company,\nDOCUMENTS.from_to,\nDOCUMENTS.serial_no,\nDOCUMENTS.issue_date,\nDOCUMENTS.place,\nDOCUMENTS.name,\nDOCUMENTS.due_date,\nDOCUMENTS.currency,\nDOCUMENTS.amount,\nDOCUMENTS.book_value,\nDOCUMENTS.vat_amount,\nDOCUMENTS.vat_category,\nDOCUMENTS.vat_number,\nDOCUMENTS.inc_exp_category,\nDOCUMENTS.inc_exp_group,\nDOCUMENTS.document_subject,\nDOCUMENTS.document_subsubject,\nDOCUMENTS.document_category,\nDOCUMENTS.transaction_type,\nDOCUMENTS.journal_company,\nDOCUMENTS.journal_series,\nDOCUMENTS.journal_number,\nDOCUMENTS.journal_line,\nDOCUMENTS.journal_date,\nDOCUMENTS.journal_status,\nDOCUMENTS.journal_user,\nDOCUMENTS.journal_posting,\nDOCUMENTS.accrued_on_date,\nDOCUMENTS.accrued_by_user,\nDOCUMENTS.document_status,\nDOCUMENTS.created_by_user,\nDOCUMENTS.finalized_by_user,\nDOCUMENTS.filed_to,\nDOCUMENTS.bank,\nDOCUMENTS.budget,\nDOCUMENTS.open_item_status,\nDOCUMENTS.matching_company,\nDOCUMENTS.matching_series,\nDOCUMENTS.matching_number,\nDOCUMENTS.matching_line,\nDOCUMENTS.debit_credit,\nDOCUMENTS.remarks,\nDOCUMENTS.operation_code1,\nDOCUMENTS.operation_id1,\nDOCUMENTS.operation_code2,\nDOCUMENTS.operation_id2,\nDOCUMENTS.allocation_date_from,\nDOCUMENTS.allocation_date_to,\nDOCUMENTS.entry_number,\nDOCUMENTS.tot_local_debit,\nDOCUMENTS.tot_local_credit,\nDOCUMENTS.tot_book_debit,\nDOCUMENTS.tot_book_credit,\nDOCUMENTS.flag1,\nDOCUMENTS.flag2,\nDOCUMENTS.reporting_amount,\nDOCUMENTS.set_currency_amount,\nDOCUMENTS.approval_level,\nDOCUMENTS.book_value_off,\nDOCUMENTS.book_debit_off,\nDOCUMENTS.book_credit_off,\nDOCUMENTS.pay_flag,\nDOCUMENTS.prt_flag,\nDOCUMENTS.accrual_type,\nDOCUMENTS.entry_rate,\nDOCUMENTS.bunker_qty,\nDOCUMENTS.bunker_price,\nDOCUMENTS.application_code,\nDOCUMENTS.application_ref,\nDOCUMENTS.operation_subid_1,\nDOCUMENTS.operation_subid_2,\nDOCUMENTS.entry_rate2,\nDOCUMENTS.book_value2,\nDOCUMENTS.tot_book_debit2,\nDOCUMENTS.tot_book_credit2,\nDOCUMENTS.currency3,\nDOCUMENTS.entry_rate3,\nDOCUMENTS.book_value3,\nDOCUMENTS.tot_book_debit3,\nDOCUMENTS.tot_book_credit3,\nDOCUMENTS.team,\nDOCUMENTS.job_number,\nDOCUMENTS.vessel_code,\nDOCUMENTS.ar_type,\nDOCUMENTS.approved_by,\nDOCUMENTS.import_status,\nDOCUMENTS.imported_by,\nDOCUMENTS.sup_match,\nDOCUMENTS.journal_user_2,\nDOCUMENTS.accrued_by_user_2,\nDOCUMENTS.created_by_user_2,\nDOCUMENTS.finalized_by_user_2,\nDOCUMENTS.flag3,\nDOCUMENTS.order_number,\nDOCUMENTS.supplier_code,\nDOCUMENTS.last_updated,\nDOCUMENTS.db_userid,\nDOCUMENTS.fx_rate,\nDOCUMENTS.mc_reference,\nDOCUMENTS.spot_rate_flag,\nDOCUMENTS.filed_to3,\nDOCUMENTS.pay_approval_level,\nDOCUMENTS.pay_selected,\nDOCUMENTS.payment_method,\nDOCUMENTS.withholding_tax_amount,\nDOCUMENTS.instrument_no,\nDOCUMENTS.withholding_tax_code,\nDOCUMENTS.flag4,\nDOCUMENTS.submission_date,\nDOCUMENTS.value_date,\nDOCUMENTS.transaction_cost,\nDOCUMENTS.accrual_flag,\ncoalesce(VW_REQUISITIONS1.order_code,VW_REQUISITIONS2.order_code,VW_REQUISITIONS3.order_code) as order_code, \ncoalesce(VW_REQUISITIONS1.document_code,VW_REQUISITIONS2.document_code,VW_REQUISITIONS3.document_code) as document_code,\ncoalesce(a.INTERNAL_REF,b.INTERNAL_REF,c.INTERNAL_REF,d.INTERNAL_REF) as internal_ref,\nrow_number() over(partition by DOCUMENTS.journal_company, DOCUMENTS.journal_series, DOCUMENTS.journal_number,DOCUMENTS.journal_line,DOCUMENTS.w_source_system order by DOCUMENTS.journal_date) as row_num,\ncoalesce(Dim_gl_company_vessel.company_id,Dim_gl_company.company_id,'0000') as company_id,\ncoalesce(dim_gl_vessel.vessel_id,'0000') as vessel_id,\ncoalesce(Dim_gl_service.service_id,'00') as service_id,\ncoalesce(Dim_gl_account.account_id,'000000') as account_id,\n/*Dim_gl_department.department_id*/ '000' as department_id,\n/*Dim_gl_intercompany.intercompany_id*/'0000' as intercompany_id,\n/*Dim_gl_future1.future1_id*/'000' as future1_id,\n/*Dim_gl_future2.future2_id*/'0000' as future2_id,\n/*case when dim_gl_vessel.vessel_code is null then 0 else dim_gl_vessel.vessel_code end as vessel_code,*/\n/*case when dim_gl_vessel.vessel_code is null then Dim_gl_company.company_code else dim_gl_vessel.owning_entity_codes end as company_code,*/\n/*company_code~vessel_code~service_code~account_code~department_code~intercompany_code~future1_code~future2_code~w_source_system*/\ncoalesce(Dim_gl_company_vessel.company,Dim_gl_company.company,'')||'~'||coalesce((case when dim_gl_vessel.vessel_code is null then 0 else dim_gl_vessel.vessel_code end),'')||'~'||coalesce(Dim_gl_service.service_code,'')||'~'||coalesce(Dim_gl_account.oracle_natural_account,'')||'~'||'0'||'~'||'0000'||'~'||'0'||'~'||'0'||'~'||DOCUMENTS.w_source_system as code_combination_id,\nDOCUMENTS.integration_key,\nDOCUMENTS.narrative as journal_narrative,\nDOCUMENTS.journal_reference,\nDOCUMENTS.journal_id,\nDOCUMENTS.tot_global_credit,\nDOCUMENTS.tot_global_debit,\nDOCUMENTS.w_x_custom,\nDOCUMENTS.w_job_instance_id,\nDOCUMENTS.w_refresh_ts,\nDOCUMENTS.w_curr_rec_flg,\nDOCUMENTS.w_data_src_id,\nDOCUMENTS.w_location,\nDOCUMENTS.w_batch_id,\nDOCUMENTS.w_business_dt as business_date,\n0 as delete_flag\nfrom \n(\nselect \ndocument_date,\ndocument_type,\nour_company,\nfrom_to,\nserial_no,\nissue_date,\nplace,\nnarrative,\nname,\ndue_date,\ncurrency,\namount,\nbook_value,\nvat_amount,\nvat_category,\nvat_number,\ninc_exp_category,\ninc_exp_group,\ndocument_subject,\ndocument_subsubject,\ndocument_category,\ntransaction_type,\njournal_company,\njournal_series,\njournal_number,\njournal_line,\njournal_date,\njournal_status,\njournal_user,\njournal_posting,\naccrued_on_date,\naccrued_by_user,\ndocument_status,\ncreated_by_user,\nfinalized_by_user,\nfiled_to,\nbank,\nbudget,\nopen_item_status,\nmatching_company,\nmatching_series,\nmatching_number,\nmatching_line,\ndebit_credit,\nremarks,\noperation_code1,\noperation_id1,\noperation_code2,\noperation_id2,\nallocation_date_from,\nallocation_date_to,\nentry_number,\ntot_local_debit,\ntot_local_credit,\ntot_book_debit,\ntot_book_credit,\nflag1,\nflag2,\nreporting_amount,\nset_currency_amount,\napproval_level,\nbook_value_off,\nbook_debit_off,\nbook_credit_off,\npay_flag,\nprt_flag,\naccrual_type,\nentry_rate,\nbunker_qty,\nbunker_price,\napplication_code,\napplication_ref,\noperation_subid_1,\noperation_subid_2,\nentry_rate2,\nbook_value2,\ntot_book_debit2,\ntot_book_credit2,\ncurrency3,\nentry_rate3,\nbook_value3,\ntot_book_debit3,\ntot_book_credit3,\nteam,\njob_number,\nvessel_code,\nar_type,\napproved_by,\nimport_status,\nimported_by,\nsup_match,\njournal_user_2,\naccrued_by_user_2,\ncreated_by_user_2,\nfinalized_by_user_2,\nflag3,\norder_number,\nsupplier_code,\nlast_updated,\ndb_userid,\nfx_rate,\nmc_reference,\nspot_rate_flag,\nfiled_to3,\npay_approval_level,\npay_selected,\npayment_method,\nwithholding_tax_amount,\ninstrument_no,\nwithholding_tax_code,\nflag4,\nsubmission_date,\nvalue_date,\ntransaction_cost,\naccrual_flag,\nw_source_system,\nx.JOURNAL_COMPANY||'/'||x.JOURNAL_SERIES||'/'||x.JOURNAL_NUMBER  as Journal_Reference,\nx.journal_company||'~'||x.journal_series||'~'||x.journal_number||'~'||x.journal_line||'~'||x.w_source_system as journal_id,\ntot_book_credit as tot_global_credit,\ntot_book_debit as tot_global_debit,\nsubstr(x.NARRATIVE , -15) as join_cond3,\nintegration_key,\nnull as w_x_custom,\nw_job_instance_id,\nw_refresh_ts,\nnull as w_curr_rec_flg,\nw_source_system as w_data_src_id,\nw_location,\nw_batch_id,\nw_business_dt\nfrom ${p_epsdl_sri_db}.sri_documents x\n) as DOCUMENTS\nleft join\nVW_REQUISITIONS as VW_REQUISITIONS1\non\nDOCUMENTS.ORDER_NUMBER = VW_REQUISITIONS1.ORDER_CODE \nand VW_REQUISITIONS1.w_business_dt='${business_date}'\nleft join\nVW_REQUISITIONS as VW_REQUISITIONS2\non\nVW_REQUISITIONS2.JOURNAL_REFERENCE = DOCUMENTS.Journal_Reference\nand VW_REQUISITIONS2.w_business_dt='${business_date}'\nleft join\nVW_REQUISITIONS as VW_REQUISITIONS3\non\nVW_REQUISITIONS3.ORDER_CODE = join_cond3\nand VW_REQUISITIONS3.w_business_dt='${business_date}'\nleft join\n${p_epsdl_sri_db}.sri_expected_call_da a\non\n(DOCUMENTS.JOURNAL_COMPANY||DOCUMENTS.JOURNAL_SERIES||DOCUMENTS.JOURNAL_NUMBER)=(a.INITIAL_JOURNAL_COMPANY||a.INITIAL_JOURNAL_SERIES||a.INITIAL_JOURNAL_NUMBER)\nand a.w_business_dt='${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_expected_call_da b\non\nDOCUMENTS.JOURNAL_COMPANY||DOCUMENTS.JOURNAL_SERIES||DOCUMENTS.JOURNAL_NUMBER=b.SECOND_JOURNAL_COMPANY||b.SECOND_JOURNAL_SERIES||b.SECOND_JOURNAL_NUMBER\nand b.w_business_dt='${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_expected_call_da c\non\nDOCUMENTS.JOURNAL_COMPANY||DOCUMENTS.JOURNAL_SERIES||DOCUMENTS.JOURNAL_NUMBER=c.THIRD_JOURNAL_COMPANY||c.THIRD_JOURNAL_SERIES||c.THIRD_JOURNAL_NUMBER\nand c.w_business_dt='${business_date}'\nleft join \n${p_epsdl_sri_db}.sri_expected_call_da d\non\nDOCUMENTS.JOURNAL_COMPANY||DOCUMENTS.JOURNAL_SERIES||DOCUMENTS.JOURNAL_NUMBER=d.FINAL_JOURNAL_COMPANY||d.FINAL_JOURNAL_SERIES||d.FINAL_JOURNAL_NUMBER\nand d.w_business_dt='${business_date}'\nleft join\n${p_epsdl_db}.Dim_gl_account Dim_gl_account\non\nDim_gl_account.ledger_card=DOCUMENTS.FROM_TO\nand\nDim_gl_account.source_system=DOCUMENTS.w_source_system\nleft join\n${p_epsdl_db}.dim_gl_vessel dim_gl_vessel  \non\n(case when DOCUMENTS.serial_no like 'MTM %' then DOCUMENTS.our_company||left(DOCUMENTS.serial_no,4) \n else DOCUMENTS.our_company end)=dim_gl_vessel.vessel_code\n\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_company where database is not null) Dim_gl_company_vessel\non\nDim_gl_company_vessel.child_value=dim_gl_vessel.owning_entity_codes\nand coalesce(Dim_gl_company_vessel.database,'default')=DOCUMENTS.w_source_system\n\nleft join\n(select * from ${p_epsdl_db}.Dim_gl_company where database is not null) Dim_gl_company\non\nDim_gl_company.company=DOCUMENTS.our_company\nand coalesce(Dim_gl_company.database,'default')=DOCUMENTS.w_source_system\n\nleft join\n${p_epsdl_db}.Dim_gl_service Dim_gl_service\non\nDim_gl_service.service_code=\n(\ncase \nwhen DOCUMENTS.operation_code1 ='T' then 11\nwhen DOCUMENTS.operation_code1 ='V' then 13\nelse\n0\nend \n)\n\n/*left join\n${p_epsdl_db}.Dim_gl_department Dim_gl_department\non\nDim_gl_department.department_code=DOCUMENTS.department_code\nleft join\n${p_epsdl_db}.Dim_gl_intercompany Dim_gl_intercompany\non\nDim_gl_intercompany.intercompany_code=DOCUMENTS.intercompany_code\nleft join\n${p_epsdl_db}.Dim_gl_future1 Dim_gl_future1\non\nDim_gl_future1.future1_code=DOCUMENTS.future1_code\nleft join\n${p_epsdl_db}.Dim_gl_future2 Dim_gl_future2\non\nDim_gl_future2.future2_code=DOCUMENTS.future2_code\n*/\nwhere DOCUMENTS.w_business_dt='${business_date}'\nand DOCUMENTS.JOURNAL_SERIES NOT IN ('YC', 'PD', 'QC', 'QT') AND DOCUMENTS.FROM_TO NOT IN ('98110','96060')\n) x\nwhere x.row_num=1"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'MANUAL'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.fact_gl_transactions"
    post_sql:
    - "merge into ${p_epsdl_db}.fact_gl_transactions as tgt using ( select distinct yesterday.journal_company,yesterday.journal_Series,yesterday.journal_number,yesterday.journal_line,yesterday.w_source_system,yesterday.journal_date from (select * from ${p_epsdl_sri_db}.sri_documents where date(w_business_dt)=date_sub(current_date(),1) and year(journal_date) in (year(current_date),(year(current_date)-1))) yesterday left join (select * from ${p_epsdl_sri_db}.sri_documents where date(w_business_dt)=current_date()) today on today.journal_company=yesterday.journal_company and today.journal_Series=yesterday.journal_Series and today.journal_number=yesterday.journal_number and today.journal_line=yesterday.journal_line and  today.w_source_system=yesterday.w_source_system where today.journal_company is null ) as src on (src.journal_company=tgt.journal_company and src.journal_Series=tgt.journal_Series and src.journal_number=tgt.journal_number and src.journal_line=tgt.journal_line and  src.w_source_system=tgt.w_data_src_id and year(tgt.journal_date) in (year(current_date),(year(current_date)-1)) ) when matched then update set tgt.delete_flag=1"
  merge_columns:
  - "accrual_type"
  - "document_date"
  - "document_type"
  - "our_company"
  - "from_to"
  - "serial_no"
  - "issue_date"
  - "place"
  - "name"
  - "due_date"
  - "currency"
  - "amount"
  - "book_value"
  - "vat_amount"
  - "vat_category"
  - "vat_number"
  - "inc_exp_category"
  - "inc_exp_group"
  - "document_subject"
  - "document_subsubject"
  - "document_category"
  - "transaction_type"
  - "journal_date"
  - "journal_status"
  - "journal_user"
  - "journal_posting"
  - "accrued_on_date"
  - "accrued_by_user"
  - "document_status"
  - "created_by_user"
  - "finalized_by_user"
  - "filed_to"
  - "bank"
  - "budget"
  - "open_item_status"
  - "matching_company"
  - "matching_series"
  - "matching_number"
  - "matching_line"
  - "debit_credit"
  - "remarks"
  - "operation_code1"
  - "operation_id1"
  - "operation_code2"
  - "operation_id2"
  - "allocation_date_from"
  - "allocation_date_to"
  - "entry_number"
  - "tot_local_debit"
  - "tot_local_credit"
  - "tot_book_debit"
  - "tot_book_credit"
  - "flag1"
  - "flag2"
  - "reporting_amount"
  - "set_currency_amount"
  - "approval_level"
  - "book_value_off"
  - "book_debit_off"
  - "book_credit_off"
  - "pay_flag"
  - "prt_flag"
  - "entry_rate"
  - "bunker_qty"
  - "bunker_price"
  - "application_code"
  - "application_ref"
  - "operation_subid_1"
  - "operation_subid_2"
  - "entry_rate2"
  - "book_value2"
  - "tot_book_debit2"
  - "tot_book_credit2"
  - "currency3"
  - "entry_rate3"
  - "book_value3"
  - "tot_book_debit3"
  - "tot_book_credit3"
  - "team"
  - "job_number"
  - "vessel_code"
  - "ar_type"
  - "approved_by"
  - "import_status"
  - "imported_by"
  - "sup_match"
  - "journal_user_2"
  - "accrued_by_user_2"
  - "created_by_user_2"
  - "finalized_by_user_2"
  - "flag3"
  - "order_number"
  - "supplier_code"
  - "last_updated"
  - "db_userid"
  - "fx_rate"
  - "mc_reference"
  - "spot_rate_flag"
  - "filed_to3"
  - "pay_approval_level"
  - "pay_selected"
  - "payment_method"
  - "withholding_tax_amount"
  - "instrument_no"
  - "withholding_tax_code"
  - "flag4"
  - "submission_date"
  - "value_date"
  - "transaction_cost"
  - "accrual_flag"
  - "order_code"
  - "document_code"
  - "internal_ref"
  - "company_id"
  - "vessel_id"
  - "service_id"
  - "account_id"
  - "department_id"
  - "intercompany_id"
  - "future1_id"
  - "future2_id"
  - "code_combination_id"
  - "journal_reference"
  - "journal_id"
  - "tot_global_credit"
  - "tot_global_debit"
  - "journal_company"
  - "journal_line"
  - "journal_number"
  - "journal_series"
  - "journal_narrative"
  - "delete_flag"
  endpoint: "lo_delta_tables"

version: 1
job:
  type: "processing"
  tags:
  - "epsdl_dim"
source:
  endpoint: "lo_delta_tables"
  properties:
    sql: "with\nvessel_list as (\nselect distinct VESSEL_CODE,short_name,company_group,v.w_business_dt,v.integration_key from (\nselect  company as vessel_code,w_business_dt,integration_key from  ${p_epsdl_sri_db}.sri_companies\n) v\nleft join  (select ci.*,row_number() over (partition by company order  by system) rnum from\n(select  company,short_name,company_group,'EPS' system from  ${p_epsdl_sri_db}.sri_companies) ci ) c\non v.vessel_code = c.company and  c.rnum = 1\n),\noth_vessel as (\n  select\n   'Jan 2014' PERIOD,\n  vessel_code VESSEL_CODE,\n  short_name VESSEL_NAME,\n  company_group COMPANY_STRUCTURE_IN_DANAOS,\n  (case when company_group in ('C', 'P', 'U', 'W') then 'QPS'  end)  QPS_OWNERSHIP,\n  case when company_group in ('C') then 'QPS'  end  QCT_OWNERSHIP,\n  case when company_group in ('U') then 'EPS UK' when  company_group in ('C', 'P', 'W','T') then 'QPS SG' end   MANAGED_BY_EPS,\n  null OWNERSHIP_TYPE,\n  null BUILT,\n  null DATE_BUILT,\n  null USEFUL_LIFE,\n  null LWT,\n  null DWT,\n  null FLEET_TYPE_SUB,\n  null FLEET_TYPE,\n to_date('01-jan-2001','dd-MMM-yyyy') START_DATE,\n  to_date('01-dec-2004','dd-MMM-yyyy') sold_date,\n  to_date('01-jan-2001','dd-MMM-yyyy') JOURNAL_START_DATE,\n  date_add(CAST(current_timestamp() as DATE), 365) JOURNAL_END_DATE,\n  null QCT_START_DATE,\n  null ADDL_ATTRIBUTE1,\n  null ADDL_ATTRIBUTE2,\n  null ADDL_ATTRIBUTE3,\n  null LAST_UPDATED_DATE,\n  null LAST_UPDATED_BY,\n  null W_SOURCE_SYSTEM,\n  w_business_dt,\n  null W_DATA_SOURCE_ID,\n  null w_refresh_ts,\n  null W_BATCH_ID,\n  null w_src_file_name,\n  null w_location,\n  null fleet,\n  null region,\n  null vessel_ownership,\n  null as w_job_instance_id,\n  p.integration_key\n  from \n  vessel_list p\n  where \n  not exists(select 1 from ${p_epsdl_sri_db}.sri_vesselmaster where p.vessel_code=vessel_code)\n  ),\n  dd_days_table as (  \n  select p.date as FULL_DATE,vessel_code, row_number() over (partition by p.date,vessel_code order by null) rnum,\n  DT_PLANNED_ENTRY, DT_ACTUAL_ENTRY,to_date(PLANNED_EXIT,'DD-MON-YYYY') DT_PLANNED_EXIT,\n  DT_ACTUAL_EXIT,dd.w_business_dt\n  from \n  ${p_epsdl_sri_db}.sri_vessel_dry_dock_details dd\n join ${p_epsdl_db}.dim_period p on p.date  between  DT_ACTUAL_ENTRY and DT_ACTUAL_EXIT\n  where dd.project_status = 'ACTUAL'\n)\nselect p.date as full_date, \nv.period,\nv.vessel_code,\nv.vessel_name,\nv.company_structure_in_danaos,\nv.qps_ownership,\ncase when p.date >= nvl(v.qct_start_date,p.date) then v.qct_ownership end qct_ownership,\ncase when managed_by_eps in ('EPS SG','EPS UK') then 'EPS' end eps_ownership,\ncase when managed_by_eps in ('EPS UK') then 'EPS UK' end eps_uk_ownership,\nv.managed_by_eps,\nv.ownership_type,\nv.built,\nv.date_built,\nv.useful_life,\nv.lwt,\nv.dwt,\nv.fleet_type_sub,\nv.fleet_type,\nv.start_date,\nv.sold_date,\nv.journal_start_date,\nv.journal_end_date,\nv.qct_start_date,\nv.addl_attribute1,\nv.addl_attribute2,\nv.addl_attribute3,\nv.last_updated_date,\nv.last_updated_by,\ncase when v.fleet_type = 'Tankers' then '01' when v.fleet_type = 'Bulkers' then '02'  when v.fleet_type = 'Containers' then '03' when v.fleet_type = 'PCTC' then '04' when v.fleet_type = 'Chemical' then '05' when v.fleet_type = 'LPG' then '06' else '07' end as FLEET_TYPE_SORT,\nv.integration_key||'~'||p.date as integration_key,\nv.w_source_system as w_data_src_id,\nv.w_business_dt as business_date,\nv.w_refresh_ts,\nv.w_batch_id,\ncase when p.date between coalesce(v.START_DATE,p.date) and nvl(v.SOLD_DATE,p.date) then 1 end ship_days,\ncase when dd.FULL_DATE is not null then 1 end dd_days,\n  dd.DT_PLANNED_ENTRY, \n  dd.DT_ACTUAL_ENTRY,\n  dd.DT_ACTUAL_EXIT, \n  dd.DT_PLANNED_EXIT,\n  v.vessel_ownership,\n  v.region,\n  v.w_job_instance_id,\n  v.w_location,\n  null as w_x_custom,\n  null as w_curr_rec_flg\nfrom \n  (\n  select  \n  period\t\t\n,vessel_code\t\t\n,vessel_name\t\t\n,company_structure_in_danaos\t\t\n,qps_ownership\t\t\n,qct_ownership\n,managed_by_eps\t\t\t\t\n,ownership_type\t\t\n,built\t\t\n,date_built\t\t\n,useful_life\t\t\n,lwt\t\t\n,dwt\t\t\n,fleet_type_sub\t\t\n,fleet_type\t\t\n,start_date\t\t\n,sold_date\t\t\n,journal_start_date\t\t\n,journal_end_date\t\t\n,qct_start_date\t\t\n,addl_attribute1\t\t\n,addl_attribute2\t\t\n,addl_attribute3\t\t\n,last_updated_date\t\t\n,last_updated_by\t\t\t\t\n,region\t\t\n,integration_key\n,w_source_system\n,w_src_file_name\n,w_refresh_ts\n,w_business_dt\n,w_location\n,w_batch_id\n,fleet\n,vessel_ownership\n,region\n,w_job_instance_id\n  from ${p_epsdl_sri_db}.sri_vesselmaster union all \n  select \n  period\t\t\n,vessel_code\t\t\n,vessel_name\t\t\n,company_structure_in_danaos\t\t\n,qps_ownership\t\t\n,qct_ownership\n,managed_by_eps\t\t\t\t\n,ownership_type\t\t\n,built\t\t\n,date_built\t\t\n,useful_life\t\t\n,lwt\t\t\n,dwt\t\t\n,fleet_type_sub\t\t\n,fleet_type\t\t\n,start_date\t\t\n,sold_date\t\t\n,journal_start_date\t\t\n,journal_end_date\t\t\n,qct_start_date\t\t\n,addl_attribute1\t\t\n,addl_attribute2\t\t\n,addl_attribute3\t\t\n,last_updated_date\t\t\n,last_updated_by\t\t\t\t\n,region\n,integration_key\t\t\n,w_source_system\n,w_src_file_name\n,w_refresh_ts\n,w_job_instance_id\n,w_business_dt\n,w_location\n,w_batch_id\n,fleet\n,vessel_ownership\n,region\n  from oth_vessel) v \njoin ${p_epsdl_db}.dim_period p on p.date between coalesce(v.JOURNAL_START_DATE,p.date) and coalesce(v.JOURNAL_END_DATE,p.date)\nleft join dd_days_table dd on p.date = dd.full_date and dd.vessel_code = v.vessel_code and dd.rnum  = 1 and p.year between '1995' and '2015' and dd.w_business_dt='${business_date[0..9]}'\nwhere v.w_business_dt='${business_date[0..9]}'"
  additional_columns:
  - name: "w_refresh_ts"
    value: "current_timestamp"
  - name: "business_date"
    value: "'${business_date}'"
  - name: "w_job_instance_id"
    value: "${job_instance_id}"
  - name: "w_batch_id"
    value: "${batch_id}"
  - name: "w_location"
    value: "'ALL'"
  - name: "w_source_system"
    value: "'NSLADMIN'"
target:
  primary_key_columns:
  - "integration_key"
  operation: "merge"
  properties:
    template: "default"
    table: "${p_epsdl_db}.dim_vessel_master_daily"
  merge_columns:
  - "addl_attribute1"
  - "addl_attribute2"
  - "addl_attribute3"
  - "built"
  - "company_structure_in_danaos"
  - "date_built"
  - "dd_days"
  - "dt_actual_entry"
  - "dt_actual_exit"
  - "dt_planned_entry"
  - "dt_planned_exit"
  - "dwt"
  - "eps_ownership"
  - "eps_uk_ownership"
  - "fleet_type"
  - "fleet_type_sort"
  - "fleet_type_sub"
  - "journal_end_date"
  - "journal_start_date"
  - "last_updated_by"
  - "last_updated_date"
  - "lwt"
  - "managed_by_eps"
  - "ownership_type"
  - "period"
  - "qct_ownership"
  - "qct_start_date"
  - "qps_ownership"
  - "ship_days"
  - "sold_date"
  - "start_date"
  - "useful_life"
  - "vessel_name"
  - "vessel_ownership"
  - "region"
  endpoint: "lo_delta_tables"
